<!doctype html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D"> 
 <head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover,maximum-scale=1,user-scalable=0"> 
  <meta name="referrer" content="unsafe-url"> 
  <title>Мир приключений по API-серверу Kubernetes. Часть 2. Наблюдение и кэширование / Хабр</title> 
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }

    /* non-breaking hyphen */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/l/font?kit=KFOlCnqEu92Fr1MmEU9vBh0_IsHAlmrO6g&skey=ee881451c540fdec&v=v29) format('woff2');
      unicode-range: U+02011;
    }
  </style> 
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.b6238726.css" as="style">
  <link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.04dfe291.js" as="script">
  <link rel="preload" href="https://assets.habr.com/habr-web/css/app.9b76199c.css" as="style">
  <link rel="preload" href="https://assets.habr.com/habr-web/js/app.de623c19.js" as="script">
  <link rel="preload" href="https://assets.habr.com/habr-web/js/7298.c8f1d73c.js" as="script"> 
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.b6238726.css">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.9b76199c.css"> 
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.20fb7121c5d9f14909af6c8354ebb9b2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script> 
  <script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/companies\/southbridge\/articles\/727510\/"},"headline":"Мир приключений по API-серверу Kubernetes. Часть 2. Наблюдение и кэширование","datePublished":"2023-04-07T16:02:21+03:00","dateModified":"2023-04-07T17:39:24+03:00","author":{"@type":"Person","name":"Аня Сокол"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"В нашей предыдущей статье про приключения сервера Kubernetes API мы рассмотрели интерфейс хранилища и исследовали единственную реализацию в дереве: etcd3. Однако...","url":"https:\/\/habr.com\/ru\/companies\/southbridge\/articles\/727510\/#post-content-body","about":["c_southbridge","h_it-infrastructure","h_devops","h_kubernetes","f_develop","f_admin"],"image":["https:\/\/habr.com\/share\/publication\/727510\/b908dcce2dca0bfeea9d535492bee058\/","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/446\/913\/a17\/446913a171b09a149098ae918196b04b.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/934\/15e\/43f\/93415e43f565a17db6ed85ce047607db.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/3a1\/e4c\/b70\/3a1e4cb705e9372e9e24451daed74cf6.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/c9c\/ee7\/777\/c9cee777704cc14b9c2e085f1788b3d0.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/966\/2c4\/00b\/9662c400bda4e392faa5d2aaf796fac5.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/4b4\/55f\/711\/4b455f711901c4aae77963b01c4330b3.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/3a1\/637\/2e5\/3a16372e5f1d1eeb7e513e97e17ef83f.png"]}</script> 
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script> 
  <style>.grecaptcha-badge{visibility: hidden;}</style> 
  <meta name="habr-version" content="2.119.0"> 
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613">
  <meta data-vue-meta="ssr" property="fb:pages" content="472597926099084">
  <meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image">
  <meta data-vue-meta="ssr" name="twitter:site" content="@habr_com">
  <meta data-vue-meta="ssr" property="og:site_name" content="Хабр" data-vmid="og:site_name">
  <meta data-vue-meta="ssr" property="og:title" content="Мир приключений по API-серверу Kubernetes. Часть 2. Наблюдение и кэширование" data-vmid="og:title">
  <meta data-vue-meta="ssr" name="twitter:title" content="Мир приключений по API-серверу Kubernetes. Часть 2. Наблюдение и кэширование" data-vmid="twitter:title">
  <meta data-vue-meta="ssr" name="aiturec:title" content="Мир приключений по API-серверу Kubernetes. Часть 2. Наблюдение и кэширование" data-vmid="aiturec:title">
  <meta data-vue-meta="ssr" name="description" content="В нашей предыдущей статье про приключения сервера Kubernetes API мы рассмотрели интерфейс хранилища и исследовали единственную реализацию в дереве: etcd3. Однако внимательное прочтение сносок в этом..." data-vmid="description">
  <meta data-vue-meta="ssr" itemprop="description" content="В нашей предыдущей статье про приключения сервера Kubernetes API мы рассмотрели интерфейс хранилища и исследовали единственную реализацию в дереве: etcd3. Однако внимательное прочтение сносок в этом..." data-vmid="description:itemprop">
  <meta data-vue-meta="ssr" property="og:description" content="В нашей предыдущей статье про приключения сервера Kubernetes API мы рассмотрели интерфейс хранилища и исследовали единственную реализацию в дереве: etcd3. Однако внимательное прочтение сносок в этом..." data-vmid="og:description">
  <meta data-vue-meta="ssr" name="twitter:description" content="В нашей предыдущей статье про приключения сервера Kubernetes API мы рассмотрели интерфейс хранилища и исследовали единственную реализацию в дереве: etcd3. Однако внимательное прочтение сносок в этом..." data-vmid="twitter:description">
  <meta data-vue-meta="ssr" property="aiturec:description" content="В нашей предыдущей статье про приключения сервера Kubernetes API мы рассмотрели интерфейс хранилища и исследовали единственную реализацию в дереве: etcd3. Однако внимательное прочтение сносок в этом..." data-vmid="aiturec:description">
  <meta data-vue-meta="ssr" itemprop="image" content="https://habrastorage.org/getpro/habr/upload_files/446/913/a17/446913a171b09a149098ae918196b04b.png" data-vmid="image:itemprop">
  <meta data-vue-meta="ssr" property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/446/913/a17/446913a171b09a149098ae918196b04b.png" data-vmid="og:image">
  <meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width">
  <meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <meta data-vue-meta="ssr" property="aiturec:image" content="https://habrastorage.org/getpro/habr/upload_files/446/913/a17/446913a171b09a149098ae918196b04b.png" data-vmid="aiturec:image">
  <meta data-vue-meta="ssr" name="twitter:image" content="https://habrastorage.org/getpro/habr/upload_files/446/913/a17/446913a171b09a149098ae918196b04b.png" data-vmid="twitter:image">
  <meta data-vue-meta="ssr" property="vk:image" content="https://habrastorage.org/getpro/habr/upload_files/446/913/a17/446913a171b09a149098ae918196b04b.png?format=vk" data-vmid="vk:image">
  <meta data-vue-meta="ssr" property="aiturec:item_id" content="727510" data-vmid="aiturec:item_id">
  <meta data-vue-meta="ssr" property="aiturec:datetime" content="2023-04-07T13:02:21.000Z" data-vmid="aiturec:datetime">
  <meta data-vue-meta="ssr" content="https://habr.com/ru/companies/southbridge/articles/727510/" property="og:url" data-vmid="og:url">
  <meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type">
  <meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale">
  <meta data-vue-meta="ssr" name="keywords" content="network, kubernetes, k8s, slurm, it-компании, it-инфраструктура, карьера программиста, карьера ит-специалиста"> 
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/publications/727510?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss">
  <link data-vue-meta="ssr" href="https://habr.com/ru/companies/southbridge/articles/727510/" rel="canonical" data-vmid="canonical">
  <link data-vue-meta="ssr" rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/446/913/a17/446913a171b09a149098ae918196b04b.png" data-vmid="image:href">
  <link data-vue-meta="ssr" rel="amphtml" href="https://habr.com/ru/amp/post/727510/"> 
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44"> 
  <meta name="msapplication-TileColor" content="#629FBC"> 
  <meta name="apple-mobile-web-app-capable" content="yes"> 
  <meta name="mobile-web-app-capable" content="yes"> 
  <link rel="shortcut icon" type="image/png" sizes="16x16" href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"> 
  <link rel="shortcut icon" type="image/png" sizes="32x32" href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"> 
  <link rel="apple-touch-icon" type="image/png" sizes="76x76" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"> 
  <link rel="apple-touch-icon" type="image/png" sizes="120x120" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"> 
  <link rel="apple-touch-icon" type="image/png" sizes="152x152" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"> 
  <link rel="apple-touch-icon" type="image/png" sizes="180x180" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"> 
  <link rel="apple-touch-icon" type="image/png" sizes="256x256" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"> 
  <link rel="mask-icon" color="#77a2b6" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"> 
  <link crossorigin="use-credentials" href="/manifest.webmanifest" rel="manifest"> 
  <script async src="https://unpkg.com/pwacompat" crossorigin="anonymous"></script> 
  <script>window.yaContextCb = window.yaContextCb || []</script> 
  <script src="https://yandex.ru/ads/system/context.js" async></script> 
 </head> 
 <body> 
  <div id="app" data-server-rendered="true" data-async-called="true">
   <div class="tm-layout__wrapper">
    <!----> 
    <div></div> <!----> 
    <header class="tm-header">
     <div class="tm-page-width">
      <div class="tm-header__container">
       <!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru">
         <svg height="16" width="16" class="tm-svg-img tm-header__icon">
          <title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use>
         </svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> 
       <div class="tm-dropdown tm-header__projects">
        <div class="tm-dropdown__head">
         <button class="tm-header__dropdown-toggle">
          <svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown">
           <title>Открыть список</title> <use xlink:href="/img/megazord-v28.c350aa68..svg#arrow-down"></use>
          </svg></button>
        </div> <!---->
       </div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn"> Как стать автором </a> 
       <div class="tm-feature tm-header__feature tm-feature tm-feature_variant-inline">
        <!---->
       </div> <!----> <!---->
      </div>
     </div>
    </header> 
    <div class="tm-layout">
     <div class="tm-page-progress-bar"></div> 
     <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky">
      <div class="tm-page-width">
       <div class="tm-base-layout__header-wrapper">
        <div class="tm-main-menu">
         <div class="tm-main-menu__section">
          <nav class="tm-main-menu__section-content">
           <!----> <a href="/ru/all/" class="tm-main-menu__item"> Все потоки </a> <a href="/ru/flows/develop/" class="tm-main-menu__item"> Разработка </a><a href="/ru/flows/admin/" class="tm-main-menu__item"> Администрирование </a><a href="/ru/flows/design/" class="tm-main-menu__item"> Дизайн </a><a href="/ru/flows/management/" class="tm-main-menu__item"> Менеджмент </a><a href="/ru/flows/marketing/" class="tm-main-menu__item"> Маркетинг </a><a href="/ru/flows/popsci/" class="tm-main-menu__item"> Научпоп </a>
          </nav>
         </div>
        </div> 
        <div class="tm-header-user-menu tm-base-layout__user-menu">
         <a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search">
          <svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark">
           <title>Поиск</title> <use xlink:href="/img/megazord-v28.c350aa68..svg#search"></use>
          </svg></a> <!----> <!----> <!----> 
         <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop">
          <div class="tm-dropdown">
           <div class="tm-dropdown__head">
            <svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_dark">
             <title>Профиль</title> <use xlink:href="/img/megazord-v28.c350aa68..svg#header-user"></use>
            </svg> <!---->
           </div> <!---->
          </div> <!---->
         </div> <!---->
        </div>
       </div>
      </div>
     </div> <!----> 
     <div class="tm-page-width"></div> 
     <main class="tm-layout__container">
      <div hl="ru" companyname="southbridge" data-async-called="true" class="tm-page">
       <div class="tm-page-width">
        <div class="tm-page__header">
         <!---->
        </div> 
        <div class="tm-page__wrapper">
         <div class="tm-page__main tm-page__main_has-sidebar">
          <div class="pull-down">
           <!----> 
           <div class="pull-down__header" style="height:0px;">
            <div class="pull-down__content" style="bottom:10px;">
             <svg height="24" width="24" class="tm-svg-img pull-down__arrow">
              <title>Обновить</title> <use xlink:href="/img/megazord-v28.c350aa68..svg#pull-arrow"></use>
             </svg>
            </div>
           </div> 
           <div class="tm-article-presenter">
            <div class="tm-company-profile-card tm-company-article__profile-card">
             <div class="tm-company-card tm-company-profile-card__info">
              <div class="tm-company-card__header">
               <a href="/ru/companies/southbridge/profile/" class="tm-company-card__avatar">
                <div class="tm-entity-image">
                 <img alt="" height="48" src="//habrastorage.org/getpro/habr/company/754/d93/3ca/754d933caeb494c6127add17ff60feb5.png" width="48" class="tm-entity-image__pic">
                </div></a> <a href="https://career.habr.com/companies/southbridge" rel="noopener" target="_blank" class="tm-grade tm-company-card__rating">
                <div class="tm-counter-container">
                 <div class="tm-counter-container__header">
                  <svg height="24" width="24" class="tm-svg-img tm-svg-grade__icon">
                   <title>Оценка компании на Хабр Карьере</title> <use xlink:href="/img/megazord-v28.c350aa68..svg#grade"></use>
                  </svg> 
                  <div class="tm-votes-lever tm-votes-lever tm-votes-lever_appearance-grade">
                   <!----> 
                   <div class="tm-votes-lever__score tm-votes-lever__score tm-votes-lever__score_appearance-grade">
                    <span class="tm-votes-lever__score-counter tm-votes-lever__score-counter tm-votes-lever__score-counter_grade"> 4.29 </span>
                   </div> <!---->
                  </div>
                 </div> 
                 <div class="tm-counter-container__footer">
                  <span class="tm-rating__text tm-rating__text tm-rating__text_variant-grade"> Оценка </span>
                 </div>
                </div></a> 
               <div class="tm-counter-container tm-company-card__rating">
                <div class="tm-counter-container__header"> 
                 <div class="tm-votes-lever tm-votes-lever tm-votes-lever_appearance-rating">
                  <!----> 
                  <div class="tm-votes-lever__score tm-votes-lever__score tm-votes-lever__score_appearance-rating">
                   <span class="tm-votes-lever__score-counter tm-votes-lever__score-counter tm-votes-lever__score-counter_rating"> 241.54 </span>
                  </div> <!---->
                 </div>
                </div> 
                <div class="tm-counter-container__footer">
                 <span class="tm-rating__text tm-rating__text"> Рейтинг </span>
                </div>
               </div> <!---->
              </div> 
              <div class="tm-company-card__info">
               <a href="/ru/companies/southbridge/profile/" class="tm-company-card__name">Southbridge</a> 
               <div class="tm-company-card__description">
                Обеспечиваем стабильную работу highload-проектов
               </div>
              </div>
             </div> <!---->
            </div> 
            <div class="tm-article-presenter__body">
             <div class="tm-misprint-area">
              <div class="tm-misprint-area__wrapper">
               <article class="tm-article-presenter__content tm-article-presenter__content_narrow">
                <div class="tm-article-presenter__header"> 
                 <div class="tm-article-snippet tm-article-presenter__snippet tm-article-snippet">
                  <div class="tm-article-snippet__meta-container">
                   <div class="tm-article-snippet__meta">
                    <span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/Anna_sokol22/" title="Anna_sokol22" class="tm-user-info__userpic">
                      <div class="tm-entity-image">
                       <img alt="" height="24" src="//habrastorage.org/r/w48/getpro/habr/avatars/8a0/768/a4b/8a0768a4b3e1a9fdcddae1bb0d0b5ee2.jpg" width="24" class="tm-entity-image__pic">
                      </div></a> <span class="tm-user-info__user"><a href="/ru/users/Anna_sokol22/" class="tm-user-info__username"> Anna_sokol22 <!----></a> <span class="tm-article-datetime-published"><time datetime="2023-04-07T13:02:21.000Z" title="2023-04-07, 16:02">9 часов назад</time></span></span></span>
                   </div> <!---->
                  </div> 
                  <h1 lang="ru" class="tm-title tm-title_h1"><span>Мир приключений по API-серверу Kubernetes. Часть 2. Наблюдение и кэширование</span></h1> 
                  <div class="tm-article-snippet__stats">
                   <!----> 
                   <div class="tm-article-reading-time">
                    <span class="tm-svg-icon__wrapper tm-article-reading-time__icon">
                     <svg height="24" width="24" class="tm-svg-img tm-svg-icon">
                      <title>Время на прочтение</title> <use xlink:href="/img/megazord-v28.c350aa68..svg#clock"></use>
                     </svg></span> <span class="tm-article-reading-time__label"> 19 мин </span>
                   </div> <span class="tm-icon-counter tm-data-icons__item">
                    <svg height="24" width="24" class="tm-svg-img tm-icon-counter__icon">
                     <title>Количество просмотров</title> <use xlink:href="/img/megazord-v28.c350aa68..svg#counter-views"></use>
                    </svg> <span class="tm-icon-counter__value">381</span></span>
                  </div> 
                  <div class="tm-article-snippet__hubs-container">
                   <div class="tm-article-snippet__hubs">
                    <span class="tm-article-snippet__hubs-item"><a href="/ru/companies/southbridge/articles/" class="tm-article-snippet__hubs-item-link router-link-active"><span>Блог компании Southbridge</span> <!----></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/it-infrastructure/" class="tm-article-snippet__hubs-item-link"><span>IT-инфраструктура</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/devops/" class="tm-article-snippet__hubs-item-link"><span>DevOps</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/kubernetes/" class="tm-article-snippet__hubs-item-link"><span>Kubernetes</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span>
                   </div>
                  </div> 
                  <div class="tm-article-snippet__labels-container">
                   <div class="tm-article-snippet__labels">
                    <!----> 
                    <div class="tm-article-snippet__label tm-article-snippet__label tm-article-snippet__label_variant-translation">
                     <span> Перевод </span>
                    </div>
                   </div>
                  </div> <!----> <!---->
                 </div>
                </div> 
                <div class="tm-article-presenter__origin">
                 <a href="https://danielmangum.com/posts/k8s-asa-watching-and-caching/" target="_blank" class="tm-article-presenter__origin-link"> Автор оригинала: <span> DANIEL MANGUM </span></a>
                </div> 
                <div data-gallery-root="" lang="ru" class="tm-article-body">
                 <div></div> 
                 <div id="post-content-body">
                  <div>
                   <div class="article-formatted-body article-formatted-body article-formatted-body_version-2">
                    <div xmlns="http://www.w3.org/1999/xhtml">
                     <figure class="full-width ">
                      <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/446/913/a17/446913a171b09a149098ae918196b04b.png" width="1080" height="609" data-src="https://habrastorage.org/getpro/habr/upload_files/446/913/a17/446913a171b09a149098ae918196b04b.png">
                     </figure>
                     <p>В нашей предыдущей статье про приключения сервера Kubernetes API мы рассмотрели интерфейс хранилища и исследовали единственную реализацию в дереве: etcd3. Однако внимательное прочтение сносок в этом посте показало, что мы были не совсем честными, говоря, что etcd3 — единственная реализация.</p>
                     <p>Это можно оспорить, ведь Cacher также может быть технической реализацией, хотя ему и требуется базовая реализация. Подробно рассмотрим кэширование в одном из будущих постов. А сейчас подробно изучим кэширование и его возможности.&nbsp;</p>
                     <figure class="full-width ">
                      <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/934/15e/43f/93415e43f565a17db6ed85ce047607db.png" width="1920" height="1080" data-src="https://habrastorage.org/getpro/habr/upload_files/934/15e/43f/93415e43f565a17db6ed85ce047607db.png">
                     </figure>
                     <p><strong>О чём поговорим в статье:</strong> </p>
                     <ul>
                      <li><p>Наблюдение (👈 «Я хочу проблему и ее решение»);</p></li>
                      <li><p>Все смотрят;</p></li>
                      <li><p>Кэширование (👈 «Мне просто нужно решение»);</p></li>
                      <li><p><code>watchCache </code>;</p></li>
                      <li><p><code>cacherListerWatcher </code>;</p></li>
                      <li><p><code>Reflector</code>;</p></li>
                      <li><p>Свяжем всё вместе;&nbsp;</p></li>
                      <li><p>Метод <code>&nbsp;Watch()</code>;</p></li>
                      <li><p>Все смотрят… Успешно (👈 «Просто покажите мне код»).</p></li>
                     </ul>
                     <h2>Наблюдение</h2>
                     <p>Прежде чем мы введем какой-либо тип кэширования, стоит вернуться к тому факту, что <code>storage.Interface</code> включает в себя метод <code>Watch</code>, реализация <code>etcd3</code>&nbsp;<a href="https://github.com/kubernetes/kubernetes/blob/3154010eec3488dd64110e3ca6c4ba0b5ac61310/staging/src/k8s.io/apiserver/pkg/storaghttps://github.com/kubernetes/kubernetes/blob/3154010eec3488dd64110e3ca6c4ba0b5ac61310/staging/src/k8s.io/apiserver/pkg/storage/etcd3/store.go#L847e/etcd3/store.go#L847"><u>поддерживает его</u></a>. Ранее <a href="https://danielmangum.com/posts/k8s-asa-the-storage-interface/#our-good-friend-etcd"><u>мы изучали</u></a> возможность отслеживания изменений, обращаясь непосредственно к <code>etcd</code> с помощью <code>etcdctl</code>. <code>etcd</code> предлагает <a href="https://etcd.io/docs/v3.5/learning/api/#watch-api"><u>Watch API</u></a>, который использует двунаправленные потоки gRPC для доставки событий клиентам при изменении значения для <a href="https://grpc.io/docs/what-is-grpc/core-concepts/#bidirectional-streaming-rpc"><u>ключа</u></a>.</p>
                     <p>Реализация etcd3 Watch <a href="https://github.com/kubernetes/kubernetes/blob/3154010eec3488dd64110e3ca6c4ba0b5ac61310/staging/src/k8s.io/apiserver/pkg/storage/etcd3/store.go#L856"><u>создает </u></a><code>watch.Interface</code>, поддерживаемый <code>watcher</code>. Новый <code>watcher</code> создается при каждом вызове <code>Watch</code>, и каждый <code>watcher</code>, по сути, просто вызывает <code>etcd</code> Watch API и пересылает события по каналу.</p>
                     <p>Давайте возьмем нашу программу из <a href="https://habr.com/ru/companies/southbridge/articles/727470/"><u>предыдущего поста</u></a> и модифицируем её, чтобы отслеживать изменения во всех <code>ConfigMaps</code> в кластере.</p>
                     <p>Вы можете найти инструкции о том, как получить данные PCI, необходимые для связи с <code>etcd</code> в кластере <code>kind</code>, <a href="https://danielmangum.com/posts/k8s-asa-the-storage-interface/#calling-the-storageinterface-directly"><u>здесь</u></a>.</p>
                     <p><code>directwatch.go</code></p>
                     <pre><code>package main

import (
	"context"
	"fmt"

	"go.etcd.io/etcd/client/pkg/v3/transport"
	clientv3 "go.etcd.io/etcd/client/v3"
	v1 "k8s.io/api/core/v1"
	"k8s.io/apimachinery/pkg/runtime"
	"k8s.io/apimachinery/pkg/runtime/serializer"
	"k8s.io/apiserver/pkg/storage"
	"k8s.io/apiserver/pkg/storage/etcd3"
	"k8s.io/apiserver/pkg/storage/value/encrypt/identity"
	"k8s.io/kubernetes/pkg/apis/core"
	k8sv1 "k8s.io/kubernetes/pkg/apis/core/v1"
)

func main() {
	tlsConfig, err := (transport.TLSInfo{
		CertFile:       "./pki/etcd/server.crt",
		KeyFile:        "./pki/etcd/server.key",
		TrustedCAFile:  "./pki/etcd/ca.crt",
		ClientCertFile: "./pki/apiserver-etcd-client.crt",
		ClientKeyFile:  "./pki/apiserver-etcd-client.key",
	}).ClientConfig()
	if err != nil {
		panic(err)
	}
	c, err := clientv3.New(clientv3.Config{
		Endpoints: []string{"https://127.0.0.1:2379"},
		TLS:       tlsConfig,
	})
	if err != nil {
		panic(err)
	}

	scheme := runtime.NewScheme()
	k8sv1.AddToScheme(scheme)
	core.AddToScheme(scheme)
	f := serializer.NewCodecFactory(scheme)
	s := etcd3.New(c, f.CodecForVersions(nil, f.UniversalDecoder(), nil, k8sv1.SchemeGroupVersion), nil, "registry", v1.Resource("ConfigMap"), identity.NewEncryptCheckTransformer(), true, etcd3.NewDefaultLeaseManagerConfig())
	w, err := s.Watch(context.Background(), "configmaps", storage.ListOptions{
		Predicate: storage.Everything,
		Recursive: true,
	})
	if err != nil {
		panic(err)
	}
	for e := range w.ResultChan() {
		co, ok := e.Object.(*v1.ConfigMap)
		if !ok {
			panic("not a config map!")
		}
		fmt.Printf("%s || %s/%s\n", e.Type, co.Namespace, co.Name)
	}
}</code></pre>
                     <p>Обратите внимание на тот факт, что мы регистрируем типы из <code>k8s.io/kubernetes</code> скорее, чем <code>k8s.io/api</code>. Это нужно, чтобы выполнить преобразование <code>internal</code> версии в нашу желаемую версию (<code>v1</code>). Мы также передаем <code>nil &nbsp;CodecForVersions,</code> поскольку декодируем их только при чтении событий потока.</p>
                     <p>Если у вас запущен кластер <code>kind</code>, вы можете начать перенаправление портов <code>etcd Pod</code>.</p>
                     <pre><code>$ kubectl port-forward -n kube-system pod/etcd-kind-control-plane 2379:2379</code></pre>
                     <p>Теперь мы можем начать нашу программу.</p>
                     <pre><code>$ go run directwatch.go
ADDED || default/kube-root-ca.crt
ADDED || kube-node-lease/kube-root-ca.crt
ADDED || kube-public/cluster-info
ADDED || kube-public/kube-root-ca.crt
ADDED || kube-system/coredns
ADDED || kube-system/extension-apiserver-authentication
ADDED || kube-system/kube-proxy
ADDED || kube-system/kube-root-ca.crt
ADDED || kube-system/kubeadm-config
ADDED || kube-system/kubelet-config
ADDED || local-path-storage/kube-root-ca.crt
ADDED || local-path-storage/local-path-config</code></pre>
                     <p>Как и ожидалось, мы получаем <code>ADDED</code> события для всех <code>ConfigMaps</code>, находящихся в данный момент в кластере. Можно создавать, обновлять и удалять <code>ConfigMap</code>, чтобы увидеть, как другие события отражаются в потоке просмотра.</p>
                     <pre><code>$ kubectl create configmap k8s-asa --from-literal hello=world
configmap/k8s-asa created

$ kubectl create configmap k8s-asa --from-literal hello=asa -o yaml --dry-run | kubectl apply -f -
configmap/k8s-asa configured

$ kubectl delete configmap k8s-asa
configmap "k8s-asa" deleted</code></pre>
                     <p>Посмотрим на каждое из этих событий в потоке просмотра с соответствующим типом.</p>
                     <pre><code>ADDED || default/k8s-asa
MODIFIED || default/k8s-asa
DELETED || default/k8s-asa</code></pre>
                     <h2>Общее наблюдение</h2>
                     <p>Теперь мы можем получать события в любое время, когда меняется интересующий нас тип, и не похоже, что <code>etcd</code> или наша маленькая программа сильно «потеют». Но давайте взглянем на некоторые показатели <code>etcd</code>, чтобы убедиться в этом. Мы можем найти открытый адрес метрик для <code>etcd</code> в нашем кластере <code>kind</code>, просмотрев команду для контейнера в модуле <code>Pod</code>.</p>
                     <pre><code>$ kubectl get pod -n kube-system etcd-kind-control-plane -o=jsonpath={.spec.containers[0].command} | jq .

[
  "etcd",
  "--advertise-client-urls=https://172.19.0.2:2379",
  "--cert-file=/etc/kubernetes/pki/etcd/server.crt",
  "--client-cert-auth=true",
  "--data-dir=/var/lib/etcd",
  "--experimental-initial-corrupt-check=true",
  "--experimental-watch-progress-notify-interval=5s",
  "--initial-advertise-peer-urls=https://172.19.0.2:2380",
  "--initial-cluster=kind-control-plane=https://172.19.0.2:2380",
  "--key-file=/etc/kubernetes/pki/etcd/server.key",
  "--listen-client-urls=https://127.0.0.1:2379,https://172.19.0.2:2379",
  "--listen-metrics-urls=http://127.0.0.1:2381",
  "--listen-peer-urls=https://172.19.0.2:2380",
  "--name=kind-control-plane",
  "--peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt",
  "--peer-client-cert-auth=true",
  "--peer-key-file=/etc/kubernetes/pki/etcd/peer.key",
  "--peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt",
  "--snapshot-count=10000",
  "--trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt"
]</code></pre>
                     <p><code>--listen-metrics-urls</code> &nbsp;— то, что мы ищем .<code>etcd</code> будет обслуживать <a href="https://danielmangum.com/posts/k8s-asa-watching-and-caching/"><u>показатели </u></a>Prometheus в конечной точке <code>/metrics</code> по этому адресу. Создаём минимальный конфигурационный файл Prometheus, чтобы дать команду сборщику выполнить очистку <code>etcd</code>.</p>
                     <p><code>prometheus.yml</code></p>
                     <pre><code>global:
  scrape_interval: 1s
scrape_configs:
  - job_name: etcd
    static_configs:
    - targets: ['127.0.0.1:2379']</code></pre>
                     <p>Прежде чем мы запустим Prometheus, убедитесь, что можно получить доступ к конечной точке <code>etcd metrics</code>. Перенаправление портов в пространство имен <code>host network</code> позволит запускать Prometheus в пространстве имен <code>host network</code>, что упрощает доступ к панели мониторинга в браузере.</p>
                     <p>Перенесите конечную точку <code>etcd metrics</code>.</p>
                     <pre><code>$ kubectl port-forward -n kube-system pod/etcd-kind-control-plane 2381:2381</code></pre>
                     <p>Затем запустите контейнер Prometheus, подключённый к сети хоста. </p>
                     <pre><code>$ docker run --net=host --rm -v $(pwd)/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus</code></pre>
                     <p>Панель мониторинга Prometheus теперь должна быть доступна в браузере по адресу <code>127.0.0.1:9090</code>. Мы можем получить график показателей, которые предоставляет <code>etcd</code>, введя запрос. Например, <code>irate(process_cpu_seconds_total{job="etcd"}[5m])</code> покажет скорость увеличения общего системного и пользовательского процессорного времени. Если запустить программу сейчас, которая устанавливает просмотры для <code>ConfigMaps</code>, мы не увидим существенного влияния на процессор.</p>
                     <figure class="full-width ">
                      <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/3a1/e4c/b70/3a1e4cb705e9372e9e24451daed74cf6.png" width="3836" height="2000" data-src="https://habrastorage.org/getpro/habr/upload_files/3a1/e4c/b70/3a1e4cb705e9372e9e24451daed74cf6.png">
                     </figure>
                     <p>Диапазон по оси Y составляет от <code>0.03</code><em> до </em><code>0.23</code>.</p>
                     <p><strong>Примечание:</strong> Поскольку мы запускаем <code>etcd</code> в кластере <code>kind</code>, сервер API Kubernetes и другие компоненты взаимодействуют с ним в дополнение к нагрузке от программы.</p>
                     <p>Этого и следовало ожидать: одни часы вряд ли окажут существенное влияние. Но если мы увеличим количество часов, то начнем сталкиваться с проблемами. Давайте настроим нашу программу так, чтобы она запускала 10 000 просмотров на <code>ConfigMaps</code>.</p>
                     <p><code>manydirectwatch.go</code></p>
                     <pre><code>package main

import (
	"context"
	"fmt"
	"os"
	"os/signal"

	"go.etcd.io/etcd/client/pkg/v3/transport"
	clientv3 "go.etcd.io/etcd/client/v3"
	v1 "k8s.io/api/core/v1"
	"k8s.io/apimachinery/pkg/runtime"
	"k8s.io/apimachinery/pkg/runtime/serializer"
	"k8s.io/apiserver/pkg/storage"
	"k8s.io/apiserver/pkg/storage/etcd3"
	"k8s.io/apiserver/pkg/storage/value/encrypt/identity"
	"k8s.io/kubernetes/pkg/apis/core"
	k8sv1 "k8s.io/kubernetes/pkg/apis/core/v1"
)

func main() {
	tlsConfig, err := (transport.TLSInfo{
		CertFile:       "./pki/etcd/server.crt",
		KeyFile:        "./pki/etcd/server.key",
		TrustedCAFile:  "./pki/etcd/ca.crt",
		ClientCertFile: "./pki/apiserver-etcd-client.crt",
		ClientKeyFile:  "./pki/apiserver-etcd-client.key",
	}).ClientConfig()
	if err != nil {
		panic(err)
	}
	c, err := clientv3.New(clientv3.Config{
		Endpoints: []string{"https://127.0.0.1:2379"},
		TLS:       tlsConfig,
	})
	if err != nil {
		panic(err)
	}

	scheme := runtime.NewScheme()
	k8sv1.AddToScheme(scheme)
	core.AddToScheme(scheme)
	f := serializer.NewCodecFactory(scheme)
	s := etcd3.New(c, f.CodecForVersions(nil, f.UniversalDecoder(), nil, k8sv1.SchemeGroupVersion), nil, "registry", v1.Resource("ConfigMap"), identity.NewEncryptCheckTransformer(), true, etcd3.NewDefaultLeaseManagerConfig())
	for i := 0; i &lt; 10000; i++ {
		w, err := s.Watch(context.Background(), "configmaps", storage.ListOptions{
			Predicate: storage.Everything,
			Recursive: true,
		})
		if err != nil {
			panic(err)
		}
		go func() {
			for e := range w.ResultChan() {
				co, ok := e.Object.(*v1.ConfigMap)
				if !ok {
					panic("not a config map!")
				}
				fmt.Printf("%s || %s/%s\n", e.Type, co.Namespace, co.Name)
			}
		}()
	}

	stop := make(chan os.Signal)
	signal.Notify(stop, os.Interrupt)
	&lt;-stop
}</code></pre>
                     <p>Если мы запустим программу сейчас, то должны увидеть, что все 10 000 просмотров получают список всех <code>ConfigMaps</code> в кластере. Когда создадим новую <code>ConfigMap</code>, мы сможем увидеть, что все часы получают уведомления.</p>
                     <pre><code>$ go run manysimplewatch.go
...
ADDED || kube-system/kube-proxy
ADDED || kube-system/kube-root-ca.crt
ADDED || kube-system/kubeadm-config
ADDED || kube-system/kubelet-config
ADDED || local-path-storage/kube-root-ca.crt
ADDED || local-path-storage/local-path-config
ADDED || kube-system/kube-root-ca.crt
ADDED || kube-system/kubeadm-config
ADDED || kube-system/kubelet-config
ADDED || local-path-storage/kube-root-ca.crt
ADDED || local-path-storage/local-path-config
...</code></pre>
                     <pre><code>$ kubectl create configmap testing
configmap/testing created</code></pre>
                     <pre><code>...
ADDED || default/testing
ADDED || default/testing
ADDED || default/testing
ADDED || default/testing
ADDED || default/testing
ADDED || default/testing
ADDED || default/testing
ADDED || default/testing
ADDED || default/testing
ADDED || default/testing
...</code></pre>
                     <p>Оглядываясь назад на наши показатели <code>etcd</code>, мы видим значительный скачок производительности процессора при запуске программы. Это вызывает беспокойство, но, возможно, еще более неприятным является объем работы, который был проделан при создании новой <code>ConfigMap</code>. Пока нагрузка моделируется в программе, сервер Kubernetes API обслуживает запросы на просмотр от различных клиентов. Устанавливать наблюдение в <code>etcd</code> для каждого из них нет необходимости, ведь серверу API требуется только одно уведомление, чтобы проинформировать всех клиентов.</p>
                     <figure class="full-width ">
                      <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/c9c/ee7/777/c9cee777704cc14b9c2e085f1788b3d0.png" width="3830" height="2016" data-src="https://habrastorage.org/getpro/habr/upload_files/c9c/ee7/777/c9cee777704cc14b9c2e085f1788b3d0.png">
                     </figure>
                     <p>Диапазон значений по оси Y составляет от <code>0,00</code> до <code>3,00</code>.</p>
                     <p>Первый большой всплеск соответствует моменту запуска нашей программы. Второй всплеск, хотя и меньший, соответствует созданию единой <code>ConfigMap</code> с установленными 10 000 наблюдениями.</p>
                     <h2>Кэширование</h2>
                     <p>Как вы догадались, сервер API Kubernetes использует стратегию кэширования для решения этой проблемы, и взаимодействие со слоем кэширования во многом похоже на прямой вызов <code>etcd3 storage.Interface</code>. Фактически, уровень кэширования реализует <code>storage.Interface</code> тоже.</p>
                     <p>При построении <code>cacher.Cacher</code> передается структура <code>Config</code>, которая включает в себя <code>storage.Interface</code>. Как указано в <a href="https://github.com/kubernetes/kubernetes/blob/e818649c10f29bc80b874889a448da4023918330/staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go#L241"><u>строке документа</u></a>.&nbsp;</p>
                     <pre><code>// Cacher implements storage.Interface (although most of the calls are just
// delegated to the underlying storage).</code></pre>
                     <p>Например, поскольку <code>etcd</code> информирует наблюдателя о событиях создания (<code>ADDED</code>), <a href="https://github.com/kubernetes/kubernetes/blob/e818649c10f29bc80b874889a448da4023918330/staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go#L460"><u>реализация</u> </a><code>Create() Cacher</code> напрямую вызывает <code>storage Create()</code>.</p>
                     <pre><code>// Create implements storage.Interface.
func (c *Cacher) Create(ctx context.Context, key string, obj, out runtime.Object, ttl uint64) error {
	return c.storage.Create(ctx, key, obj, out, ttl)
}</code></pre>
                     <p>Другие методы выполняют незначительные операции перед вызовом базового <code>storage</code>, но <code>Watch()</code> вообще не взаимодействует с ним напрямую. Вместо этого он создает новый <code>cacheWatcher</code> и запускает свой цикл обработки событий. Прежде чем разобраться в том, как работает <code>cacheWatcher</code>, нужно понять, как события доставляются из <code>etcd</code> всем наблюдателям, запущенным этим методом. При создании Cacher создаются три важных базовых компонента, два из которых — реализация общих интерфейсов в пакете <code>client-go cache</code>:</p>
                     <ul>
                      <li><p><code>watchCache</code> — реализацией <code>cache.Store</code>;</p></li>
                      <li><p><code>cacherListerWatcher</code> — реализацией <code>cache.ListerWatcher</code>;</p></li>
                      <li><p><code>Reflector</code> принимает реализации двух ранее упомянутых интерфейсов и использует последний для заполнения первого.</p></li>
                     </ul>
                     <p>Давайте рассмотрим каждый из них более подробно.</p>
                     <h2>watchCache</h2>
                     <p><code>watchCache</code> &nbsp;— место, где хранится фактический кэш событий, которые передаются наблюдателям. Это скользящее окно с возможностью изменения размера. Это&nbsp; означает, что при добавлении нового элемента мы либо удаляем самый старый, либо увеличиваем размер кэша, чтобы вместить добавление нового элемента. Как упоминалось ранее, <code>watchCache</code> реализует <code>cache.Store</code>, которое поддерживает следующие методы. </p>
                     <pre><code>type Store interface {

	// Add adds the given object to the accumulator associated with the given object's key
	Add(obj interface{}) error

	// Update updates the given object in the accumulator associated with the given object's key
	Update(obj interface{}) error

	// Delete deletes the given object from the accumulator associated with the given object's key
	Delete(obj interface{}) error

	// List returns a list of all the currently non-empty accumulators
	List() []interface{}

	// ListKeys returns a list of all the keys currently associated with non-empty accumulators
	ListKeys() []string

	// Get returns the accumulator associated with the given object's key
	Get(obj interface{}) (item interface{}, exists bool, err error)

	// GetByKey returns the accumulator associated with the given key
	GetByKey(key string) (item interface{}, exists bool, err error)

	// Replace will delete the contents of the store, using instead the
	// given list. Store takes ownership of the list, you should not reference
	// it after calling this function.
	Replace([]interface{}, string) error

	// Resync is meaningless in the terms appearing here but has
	// meaning in some implementations that have non-trivial
	// additional behavior (e.g., DeltaFIFO).
	Resync() error
}</code></pre>
                     <p>Реализации <code>Add()</code>, <code>Update()</code>, и <code>Delete()</code> создают <code>watch.Event</code>, затем передайте его методу <code>processEvent()</code>. Здесь событие преобразуется в <code>watchCacheEvent</code>, который передается <code>updateCache()</code>. Метод <code>updateCache()</code> вместе с вызываемым им методом <code>resizeCacheLocked()</code> — это то, где реализована логика скользящего окна.</p>
                     <pre><code>// Assumes that lock is already held for write.
func (w *watchCache) updateCache(event *watchCacheEvent) {
	w.resizeCacheLocked(event.RecordTime)
	if w.isCacheFullLocked() {
		// Cache is full - remove the oldest element.
		w.startIndex++
	}
	w.cache[w.endIndex%w.capacity] = event
	w.endIndex++
}

// resizeCacheLocked resizes the cache if necessary:
// - increases capacity by 2x if cache is full and all cached events occurred within last eventFreshDuration.
// - decreases capacity by 2x when recent quarter of events occurred outside of eventFreshDuration(protect watchCache from flapping).
func (w *watchCache) resizeCacheLocked(eventTime time.Time) {
	if w.isCacheFullLocked() &amp;&amp; eventTime.Sub(w.cache[w.startIndex%w.capacity].RecordTime) &lt; eventFreshDuration {
		capacity := min(w.capacity*2, w.upperBoundCapacity)
		if capacity &gt; w.capacity {
			w.doCacheResizeLocked(capacity)
		}
		return
	}
	if w.isCacheFullLocked() &amp;&amp; eventTime.Sub(w.cache[(w.endIndex-w.capacity/4)%w.capacity].RecordTime) &gt; eventFreshDuration {
		capacity := max(w.capacity/2, w.lowerBoundCapacity)
		if capacity &lt; w.capacity {
			w.doCacheResizeLocked(capacity)
		}
		return
	}
}</code></pre>
                     <p>Перед возвратом из <code>processEvent()</code> вызывается функция <code>eventHandler()</code>, если она была передана во время построения <code>watchCache</code>. Мы вернемся к этому вскоре, когда рассмотрим, как наблюдатели уведомляются о событиях.</p>
                     <pre><code>// Avoid calling event handler under lock.
	// This is safe as long as there is at most one call to Add/Update/Delete and
	// UpdateResourceVersion in flight at any point in time, which is true now,
	// because reflector calls them synchronously from its main thread.
	if w.eventHandler != nil {
		w.eventHandler(wcEvent)
	}</code></pre>
                     <p>Другие методы, особенно те, которые включают получение и перечисление, полагаются на базовый <code>cache.Indexer</code>. В итоге <a href="https://github.com/kubernetes/kubernetes/blob/e818649c10f29bc80b874889a448da4023918330/staging/src/k8s.io/client-go/tools/cache/store.go#L271"><u>простые индексы</u></a>, созданные в <code>watchCache</code>, сводятся к потокобезопасной <code>map</code>. В то время как скользящее окно событий в <code>watchCache</code> помогает отправлять обновления многим различным наблюдателям, индексатор позволяет новым наблюдателям легко получать последнее состояние объектов, что требуется при запуске наблюдения.</p>
                     <p>Вместе эти два механизма обслуживают запросы из их хранилища в памяти, вместо того чтобы обращаться к <code>etcd</code> напрямую.</p>
                     <h2>cacherListerWatcher</h2>
                     <p><code>cacherListerWatcher</code> намного проще, чем <code>watchCache</code>, так как оборачивает <code>storage.Interface</code>, который передается <code>Cacher</code> и вызывает базовые методы <code>GetList()</code> и <code>Watch()</code>.</p>
                     <pre><code>// NewCacherListerWatcher returns a storage.Interface backed ListerWatcher.
func NewCacherListerWatcher(storage storage.Interface, resourcePrefix string, newListFunc func() runtime.Object) cache.ListerWatcher {
	return &amp;cacherListerWatcher{
		storage:        storage,
		resourcePrefix: resourcePrefix,
		newListFunc:    newListFunc,
	}
}

// Implements cache.ListerWatcher interface.
func (lw *cacherListerWatcher) List(options metav1.ListOptions) (runtime.Object, error) {
	list := lw.newListFunc()
	pred := storage.SelectionPredicate{
		Label:    labels.Everything(),
		Field:    fields.Everything(),
		Limit:    options.Limit,
		Continue: options.Continue,
	}

	storageOpts := storage.ListOptions{
		ResourceVersionMatch: options.ResourceVersionMatch,
		Predicate:            pred,
		Recursive:            true,
	}
	if err := lw.storage.GetList(context.TODO(), lw.resourcePrefix, storageOpts, list); err != nil {
		return nil, err
	}
	return list, nil
}

// Implements cache.ListerWatcher interface.
func (lw *cacherListerWatcher) Watch(options metav1.ListOptions) (watch.Interface, error) {
	opts := storage.ListOptions{
		ResourceVersion: options.ResourceVersion,
		Predicate:       storage.Everything,
		Recursive:       true,
		ProgressNotify:  true,
	}
	return lw.storage.Watch(context.TODO(), lw.resourcePrefix, opts)
}</code></pre>
                     <p><code>cacherListerWatcher</code> — то, что извлекает данные, которые сохраняются в <code>watchCache</code>. Но нужен механизм, чтобы связать их вместе.</p>
                     <h2>Reflector</h2>
                     <p><code>watchCache</code> и <code>cacherListerWatcher</code> создают перед <code>Reflector</code>, чтобы передать их ему. </p>
                     <pre><code>watchCache := newWatchCache(
		config.KeyFunc, cacher.processEvent, config.GetAttrsFunc, config.Versioner, config.Indexers, config.Clock, config.GroupResource)
	listerWatcher := NewCacherListerWatcher(config.Storage, config.ResourcePrefix, config.NewListFunc)
	reflectorName := "storage/cacher.go:" + config.ResourcePrefix

	reflector := cache.NewNamedReflector(reflectorName, listerWatcher, obj, watchCache, 0)</code></pre>
                     <p><code>Reflector</code> определен в пакете <code>client-go/tools/cache</code> со следующей документальной строкой. </p>
                     <pre><code>// Reflector watches a specified resource and causes all changes to be reflected in the given store.</code></pre>
                     <p>Большая часть функциональности вызывается из его метода <code>ListAndWatch()</code> Он выполняет то, что следует из его названия: перечисляет, а затем просматривает. События, поступающие от <code>ListerWatcher (cacherListerWatcher)</code>, обрабатываются в <code>watchHandler()</code>. Именно здесь данные передаются в <code>watchCache</code>.</p>
                     <pre><code>		case watch.Added:
				err := store.Add(event.Object)
				if err != nil {
					utilruntime.HandleError(fmt.Errorf("%s: unable to add watch event object (%#v) to store: %v", name, event.Object, err))
				}
			case watch.Modified:
				err := store.Update(event.Object)
				if err != nil {
					utilruntime.HandleError(fmt.Errorf("%s: unable to update watch event object (%#v) to store: %v", name, event.Object, err))
				}
			case watch.Deleted:
				// TODO: Will any consumers need access to the "last known
				// state", which is passed in event.Object? If so, may need
				// to change this.
				err := store.Delete(event.Object)
				if err != nil {
					utilruntime.HandleError(fmt.Errorf("%s: unable to delete watch event object (%#v) from store: %v", name, event.Object, err))
				}</code></pre>
                     <h2>Связываем всё вместе</h2>
                     <figure class="full-width ">
                      <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/966/2c4/00b/9662c400bda4e392faa5d2aaf796fac5.png" width="1920" height="1080" data-src="https://habrastorage.org/getpro/habr/upload_files/966/2c4/00b/9662c400bda4e392faa5d2aaf796fac5.png">
                     </figure>
                     <p>Когда все компоненты на месте, пора запустить <code>Reflector</code>, чтобы извлекать данные из <code>cacherListerWatcher</code> и сохранять их в <code>watchCache</code>, который будет информировать <code>Cacher</code> об обновлениях. </p>
                     <pre><code>go cacher.dispatchEvents()

	cacher.stopWg.Add(1)
	go func() {
		defer cacher.stopWg.Done()
		defer cacher.terminateAllWatchers()
		wait.Until(
			func() {
				if !cacher.isStopped() {
					cacher.startCaching(stopCh)
				}
			}, time.Second, stopCh,
		)
	}()</code></pre>
                     <p>Сначала рассмотрим второй вызов, <code>cacher.startCaching(stopCh)</code> — так мы запускаем <code>Reflector</code> с помощью вызова <code>ListAndWatch()</code>. </p>
                     <pre><code>func (c *Cacher) startCaching(stopChannel &lt;-chan struct{}) {
	// The 'usable' lock is always 'RLock'able when it is safe to use the cache.
	// It is safe to use the cache after a successful list until a disconnection.
	// We start with usable (write) locked. The below OnReplace function will
	// unlock it after a successful list. The below defer will then re-lock
	// it when this function exits (always due to disconnection), only if
	// we actually got a successful list. This cycle will repeat as needed.
	successfulList := false
	c.watchCache.SetOnReplace(func() {
		successfulList = true
		c.ready.set(true)
		klog.V(1).Infof("cacher (%v): initialized", c.groupResource.String())
		metrics.WatchCacheInitializations.WithLabelValues(c.groupResource.String()).Inc()
	})
	defer func() {
		if successfulList {
			c.ready.set(false)
		}
	}()

	c.terminateAllWatchers()
	// Note that since onReplace may be not called due to errors, we explicitly
	// need to retry it on errors under lock.
	// Also note that startCaching is called in a loop, so there's no need
	// to have another loop here.
	if err := c.reflector.ListAndWatch(stopChannel); err != nil {
		klog.Errorf("cacher (%v): unexpected ListAndWatch error: %v; reinitializing...", c.groupResource.String(), err)
	}
}</code></pre>
                     <p>Это приведет к тому, что <code>Reflector</code> начнет заполнять <code>watchCache</code>, который уведомит <code>Cacher</code>, чтобы он мог отправить его всем наблюдателям. Метод <code>cacher.processEvent()</code> был передан в <code>watchCache</code> как <code>eventHandler()</code>, который мы видели ранее.</p>
                     <pre><code>func (c *Cacher) processEvent(event *watchCacheEvent) {
	if curLen := int64(len(c.incoming)); c.incomingHWM.Update(curLen) {
		// Monitor if this gets backed up, and how much.
		klog.V(1).Infof("cacher (%v): %v objects queued in incoming channel.", c.groupResource.String(), curLen)
	}
	c.incoming &lt;- *event
}</code></pre>
                     <p>Всё отправляется по каналу <code>c.incoming</code>, который затем считывается в методе <code>cacher.dispatchEvents()</code>, прежде чем быть отправленным каждому наблюдателю.</p>
                     <pre><code>	case event, ok := &lt;-c.incoming:
			if !ok {
				return
			}
			// Don't dispatch bookmarks coming from the storage layer.
			// They can be very frequent (even to the level of subseconds)
			// to allow efficient watch resumption on kube-apiserver restarts,
			// and propagating them down may overload the whole system.
			//
			// TODO: If at some point we decide the performance and scalability
			// footprint is acceptable, this is the place to hook them in.
			// However, we then need to check if this was called as a result
			// of a bookmark event or regular Add/Update/Delete operation by
			// checking if resourceVersion here has changed.
			if event.Type != watch.Bookmark {
				c.dispatchEvent(&amp;event)
			}
			lastProcessedResourceVersion = event.ResourceVersion
			metrics.EventsCounter.WithLabelValues(c.groupResource.String()).Inc()</code></pre>
                     <p>Когда мы вызываем <code>c.dispatchEvent(&amp;event)</code>, список <code>cacheWatcher</code> фильтруется по тем, кто заинтересован в данном событии, и событие отправляется каждому. </p>
                     <h2>Метод Watch()</h2>
                     <p>Это было непросто, но теперь, когда мы знаем, как обрабатываются события, пришло время вернуться к методу <code>Watch()</code>. Вместо запуска нового наблюдения <code>etcd</code> при вызове этого метода, создаем <code>cacheWatcher</code>, который добавляется к кандидатам, когда <code>Cacher</code> обрабатывает события. Каждый <code>cacheWatcher</code> имеет свой собственный цикл обработки: <code>watcher.processInterval()</code>. Метод<code> Watch()</code> запускает цикл обработки для наблюдателя, который он создает после добавления его в список наблюдателей для <code>Cacher</code>.</p>
                     <pre><code>func() {
		c.Lock()
		defer c.Unlock()
		// Update watcher.forget function once we can compute it.
		watcher.forget = forgetWatcher(c, watcher, c.watcherIdx, triggerValue, triggerSupported)
		c.watchers.addWatcher(watcher, c.watcherIdx, triggerValue, triggerSupported)

		// Add it to the queue only when the client support watch bookmarks.
		if watcher.allowWatchBookmarks {
			c.bookmarkWatchers.addWatcher(watcher)
		}
		c.watcherIdx++
	}()

	go watcher.processInterval(ctx, cacheInterval, watchRV)
	return watcher, nil</code></pre>
                     <p><code>cacheInterval</code> создается <a href="https://github.com/kubernetes/kubernetes/blob/e818649c10f29bc80b874889a448da4023918330/staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go#L539"><u>ранее в методе</u> </a>и доставляет любые существующие события в <code>watchCache</code>, которые интересуют <code>cacheWatcher</code>. Метод <code>watcher.processInterval()</code> сначала обрабатывает все события из <code>cacheInterval</code>, затем начинает ожидать обработки будущих <a href="https://github.com/kubernetes/kubernetes/blob/e818649c10f29bc80b874889a448da4023918330/staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go#L1504"><u>отправленных событий</u></a>.</p>
                     <pre><code>	for {
		event, err := cacheInterval.Next()
		if err != nil {
			klog.Warningf("couldn't retrieve watch event to serve: %#v", err)
			return
		}
		if event == nil {
			break
		}
		c.sendWatchCacheEvent(event)
		// With some events already sent, update resourceVersion so that
		// events that were buffered and not yet processed won't be delivered
		// to this watcher second time causing going back in time.
		resourceVersion = event.ResourceVersion
		initEventCount++
	}</code></pre>
                     <p><strong>Примечание</strong>: некоторые комментарии к коду удалены для краткости.</p>
                     <p>Обработка событий состоит из вызова функции <code>sendWatchCacheEvent()</code>, которая преобразует его. Затем доставляет по каналу result, который становится тем же каналом, из которого вызывающие функцию <code>Watch()</code> могут считывать данные!</p>
                     <pre><code>func (c *cacheWatcher) sendWatchCacheEvent(event *watchCacheEvent) {
	watchEvent := c.convertToWatchEvent(event)
	if watchEvent == nil {
		// Watcher is not interested in that object.
		return
	}

	select {
	case &lt;-c.done:
		return
	default:
	}

	select {
	case c.result &lt;- *watchEvent:
	case &lt;-c.done:
	}
}</code></pre>
                     <p><strong>Примечание</strong>: некоторые комментарии к коду удалены для краткости.</p>
                     <h2>Все смотрят… Продуктивно </h2>
                     <p>Давайте посмотрим на реализацию&nbsp;<code>Cacher storage.Interface</code> в действии. Мы берём нашу программу и модифицируем её, чтобы передать реализацию хранилища <code>etcd Cacher</code>.</p>
                     <p><code>cachewatch.go</code></p>
                     <pre><code>package main

import (
	"context"
	"fmt"
	"os"
	"os/signal"

	"go.etcd.io/etcd/client/pkg/v3/transport"
	clientv3 "go.etcd.io/etcd/client/v3"
	v1 "k8s.io/api/core/v1"
	"k8s.io/apimachinery/pkg/fields"
	"k8s.io/apimachinery/pkg/labels"
	"k8s.io/apimachinery/pkg/runtime"
	"k8s.io/apimachinery/pkg/runtime/serializer"
	"k8s.io/apiserver/pkg/storage"
	"k8s.io/apiserver/pkg/storage/cacher"
	"k8s.io/apiserver/pkg/storage/etcd3"
	"k8s.io/apiserver/pkg/storage/value/encrypt/identity"
	"k8s.io/kubernetes/pkg/apis/core"
	k8sv1 "k8s.io/kubernetes/pkg/apis/core/v1"
	"k8s.io/utils/clock"
)

func main() {
	tlsConfig, err := (transport.TLSInfo{
		CertFile:       "./pki/etcd/server.crt",
		KeyFile:        "./pki/etcd/server.key",
		TrustedCAFile:  "./pki/etcd/ca.crt",
		ClientCertFile: "./pki/apiserver-etcd-client.crt",
		ClientKeyFile:  "./pki/apiserver-etcd-client.key",
	}).ClientConfig()
	if err != nil {
		panic(err)
	}
	c, err := clientv3.New(clientv3.Config{
		Endpoints: []string{"https://127.0.0.1:2379"},
		TLS:       tlsConfig,
	})
	if err != nil {
		panic(err)
	}

	scheme := runtime.NewScheme()
	k8sv1.AddToScheme(scheme)
	core.AddToScheme(scheme)
	f := serializer.NewCodecFactory(scheme)
	s := etcd3.New(c, f.CodecForVersions(nil, f.UniversalDecoder(), nil, k8sv1.SchemeGroupVersion), nil, "registry", v1.Resource("ConfigMap"), identity.NewEncryptCheckTransformer(), true, etcd3.NewDefaultLeaseManagerConfig())

	ca, err := cacher.NewCacherFromConfig(cacher.Config{
		Storage:        s,
		Versioner:      storage.APIObjectVersioner{},
		GroupResource:  v1.Resource("configmaps"),
		ResourcePrefix: "configmaps",
		KeyFunc:        func(o runtime.Object) (string, error) { return storage.NamespaceKeyFunc("configmaps", o) },
		GetAttrsFunc: func(o runtime.Object) (label labels.Set, field fields.Set, err error) {
			return labels.Set{},
				fields.Set{}, nil
		},
		NewFunc: func() runtime.Object {
			return &amp;v1.ConfigMap{}
		},
		NewListFunc: func() runtime.Object {
			return &amp;v1.ConfigMapList{}
		},
		Codec: f.LegacyCodec(k8sv1.SchemeGroupVersion),
		Clock: clock.RealClock{},
	})
	if err != nil {
		panic(err)
	}
	for i := 0; i &lt; 10000; i++ {
		w, err := ca.Watch(context.Background(), "configmaps", storage.ListOptions{
			Predicate: storage.Everything,
			Recursive: true,
		})
		if err != nil {
			panic(err)
		}
		go func() {
			for e := range w.ResultChan() {
				switch o := e.Object.(type) {
				case *v1.ConfigMap:
					fmt.Printf("%s || %s/%s\n", e.Type, o.Namespace, o.Name)
				default:
					co, ok := o.(runtime.CacheableObject)
					if !ok {
						panic("unknown event")
					}
					c, ok := co.GetObject().(*v1.ConfigMap)
					if !ok {
						panic("unknown object")
					}
					fmt.Printf("%s || %s/%s\n", e.Type, c.Namespace, c.Name)
				}
			}
		}()
	}

	stop := make(chan os.Signal)
	signal.Notify(stop, os.Interrupt)
	&lt;-stop
}</code></pre>
                     <p>Поскольку <code>Prometheus</code> все еще запущен и очищает наш экземпляр <code>etcd</code> в нашем кластере <code>kind</code>, мы запускаем нашу программу и видим влияние на процессор. </p>
                     <pre><code>$ go run cachewatch.go
...
ADDED || kube-system/kube-proxy
ADDED || kube-public/cluster-info
ADDED || kube-system/coredns
ADDED || default/kube-root-ca.crt
ADDED || kube-public/kube-root-ca.crt
ADDED || kube-system/kubelet-config
ADDED || kube-system/kubeadm-config
ADDED || kube-system/kubeadm-config
ADDED || local-path-storage/kube-root-ca.crt
ADDED || local-path-storage/local-path-config
ADDED || default/kube-root-ca.crt
...</code></pre>
                     <p>Хотя установлено 10 000 наблюдателей, в нашем экземпляре <code>etcd</code> нет заметного влияния на процессор. То же самое справедливо, если мы создадим новую <code>ConfigMap</code>. </p>
                     <pre><code>$ kubectl create configmap testing
configmap/testing created</code></pre>
                     <pre><code>...
ADDED || default/testing2
ADDED || default/testing2
ADDED || default/testing2
ADDED || default/testing2
ADDED || default/testing2
ADDED || default/testing2
ADDED || default/testing2
ADDED || default/testing2
ADDED || default/testing2
...</code></pre>
                     <figure class="full-width ">
                      <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/4b4/55f/711/4b455f711901c4aae77963b01c4330b3.png" width="3680" height="1956" data-src="https://habrastorage.org/getpro/habr/upload_files/4b4/55f/711/4b455f711901c4aae77963b01c4330b3.png">
                     </figure>
                     <p>Диапазон оси<em> </em>Y&nbsp;<code>0.00</code><em>до&nbsp;</em><code>0.18</code><em>.</em> </p>
                     <h2>Заключительные мысли</h2>
                     <p>Это была вторая часть серии приключений <a href="https://danielmangum.com/categories/kubernetes-api-server-adventures/"><u>сервера Kubernetes API</u></a>. Основываясь на нашем storage.Interface, мы узнали, как Kubernetes оптимизирует работу watch перед лицом потенциально большого количества клиентов. Как и в большинстве случаев в разработке программного обеспечения, эта оптимизация не лишена компромиссов, но она достигает цели сделать общий случай более эффективным. В <a href="https://slurm.club/3KhyGtd"><u>«Kubernetes: Мега»</u> </a>мы рассматриваем и затрагиваем такие области управления инфраструктурой, в которых каждое улучшение может помочь компании сэкономить сотни тысяч рублей.</p>
                     <figure class="full-width ">
                      <img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/3a1/637/2e5/3a16372e5f1d1eeb7e513e97e17ef83f.png" alt="https://slurm.club/3KhyGtd" title="https://slurm.club/3KhyGtd" width="780" height="100" data-src="https://habrastorage.org/getpro/habr/upload_files/3a1/637/2e5/3a16372e5f1d1eeb7e513e97e17ef83f.png">
                      <div>
                       <figcaption>
                        <a href="https://slurm.club/3KhyGtd">https://slurm.club/3KhyGtd</a>
                       </figcaption>
                      </div>
                     </figure>
                     <p>Мы посмотрим, есть ли какие-либо случаи, когда этот компромисс вызывает проблемы, в будущих публикациях.</p>
                     <p></p>
                    </div>
                   </div>
                  </div> <!----> <!---->
                 </div> <!----> <!---->
                </div> <!----> 
                <div class="tm-article-presenter__meta">
                 <div class="tm-separated-list tm-article-presenter__meta-list">
                  <span class="tm-separated-list__title">Теги:</span> 
                  <ul class="tm-separated-list__list">
                   <li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bnetwork%5D" class="tm-tags-list__link">network</a></li>
                   <li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bkubernetes%5D" class="tm-tags-list__link">kubernetes</a></li>
                   <li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bk8s%5D" class="tm-tags-list__link">k8s</a></li>
                   <li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bslurm%5D" class="tm-tags-list__link">slurm</a></li>
                   <li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bit-%D0%BA%D0%BE%D0%BC%D0%BF%D0%B0%D0%BD%D0%B8%D0%B8%5D" class="tm-tags-list__link">it-компании</a></li>
                   <li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bit-%D0%B8%D0%BD%D1%84%D1%80%D0%B0%D1%81%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%B0%5D" class="tm-tags-list__link">it-инфраструктура</a></li>
                   <li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BA%D0%B0%D1%80%D1%8C%D0%B5%D1%80%D0%B0%20%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%81%D1%82%D0%B0%5D" class="tm-tags-list__link">карьера программиста</a></li>
                   <li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BA%D0%B0%D1%80%D1%8C%D0%B5%D1%80%D0%B0%20%D0%B8%D1%82-%D1%81%D0%BF%D0%B5%D1%86%D0%B8%D0%B0%D0%BB%D0%B8%D1%81%D1%82%D0%B0%5D" class="tm-tags-list__link">карьера ит-специалиста</a></li>
                  </ul>
                 </div> 
                 <div class="tm-separated-list tm-article-presenter__meta-list">
                  <span class="tm-separated-list__title">Хабы:</span> 
                  <ul class="tm-separated-list__list">
                   <li class="tm-separated-list__item"><a href="/ru/companies/southbridge/articles/" class="tm-hubs-list__link router-link-active">Блог компании Southbridge</a></li>
                   <li class="tm-separated-list__item"><a href="/ru/hub/it-infrastructure/" class="tm-hubs-list__link">IT-инфраструктура</a></li>
                   <li class="tm-separated-list__item"><a href="/ru/hub/devops/" class="tm-hubs-list__link">DevOps</a></li>
                   <li class="tm-separated-list__item"><a href="/ru/hub/kubernetes/" class="tm-hubs-list__link">Kubernetes</a></li>
                  </ul>
                 </div>
                </div>
               </article>
              </div> <!---->
             </div> 
             <div class="tm-article-sticky-panel">
              <div class="tm-data-icons tm-article-sticky-panel__icons">
               <div class="tm-article-rating tm-data-icons__item">
                <div class="tm-votes-meter tm-article-rating__votes-switcher">
                 <svg height="24" width="24" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon tm-votes-meter__icon_appearance-article">
                  <title>Всего голосов 6: ↑6 и ↓0</title> <use xlink:href="/img/megazord-v28.c350aa68..svg#counter-rating"></use>
                 </svg> <span title="Всего голосов 6: ↑6 и ↓0" class="tm-votes-meter__value tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_appearance-article tm-votes-meter__value_rating">+6</span>
                </div> 
                <div class="v-portal" style="display:none;"></div>
               </div> <!----> <!----> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span class="tm-svg-icon__wrapper bookmarks-button__icon">
                 <svg height="24" width="24" class="tm-svg-img tm-svg-icon">
                  <title>Добавить в закладки</title> <use xlink:href="/img/megazord-v28.c350aa68..svg#counter-favorite"></use>
                 </svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter"> 13 </span></button> 
               <div title="Поделиться" class="tm-sharing tm-data-icons__item">
                <button type="button" class="tm-sharing__button">
                 <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="tm-sharing__icon">
                  <path fill="currentColor" d="M13.8 13.8V18l7.2-6.6L13.8 5v3.9C5 8.9 3 18.6 3 18.6c2.5-4.4 6-4.8 10.8-4.8z"></path>
                 </svg></button> 
                <div class="v-portal" style="display:none;"></div>
               </div> 
               <div title="Читать комментарии" class="tm-article-comments-counter-link tm-data-icons__item">
                <a href="/ru/companies/southbridge/articles/727510/comments/" class="tm-article-comments-counter-link__link">
                 <svg height="24" width="24" class="tm-svg-img tm-article-comments-counter-link__icon">
                  <title>Комментарии</title> <use xlink:href="/img/megazord-v28.c350aa68..svg#counter-comments"></use>
                 </svg> <span class="tm-article-comments-counter-link__value"> 0 </span></a> <!---->
               </div> <!----> 
               <div class="v-portal" style="display:none;"></div>
              </div>
             </div>
            </div> 
            <div class="tm-article-presenter__footer">
             <div class="tm-article-blocks">
              <!----> 
              <div></div> 
              <section class="tm-block tm-block tm-block_spacing-bottom">
               <!----> 
               <div class="tm-block__body tm-block__body tm-block__body_variant-balanced">
                <div class="tm-article-author">
                 <div class="tm-article-author__company">
                  <div class="tm-article-author__company-card">
                   <div class="tm-company-snippet">
                    <a href="/ru/companies/southbridge/profile/" class="tm-company-snippet__logo-link">
                     <div class="tm-entity-image">
                      <img alt="" height="40" src="//habrastorage.org/getpro/habr/company/754/d93/3ca/754d933caeb494c6127add17ff60feb5.png" width="40" class="tm-entity-image__pic">
                     </div></a> 
                    <div class="tm-company-snippet__info">
                     <a href="/ru/companies/southbridge/profile/" class="tm-company-snippet__title">Southbridge</a> 
                     <div class="tm-company-snippet__description">
                      Обеспечиваем стабильную работу highload-проектов
                     </div>
                    </div>
                   </div> 
                   <div class="tm-article-author__buttons">
                    <!----> <!---->
                   </div>
                  </div> 
                  <div class="tm-article-author__company-contacts">
                   <a href="https://southbridge.io/" rel="noopener" target="_blank" class="tm-article-author__contact"> Сайт </a><a href="https://slurm.io/" rel="noopener" target="_blank" class="tm-article-author__contact"> Сайт </a>
                  </div> 
                  <div class="tm-article-author__separator"></div>
                 </div> 
                 <div class="tm-user-card tm-article-author__user-card tm-user-card tm-user-card_variant-article">
                  <div class="tm-user-card__info-container">
                   <div class="tm-user-card__header">
                    <div class="tm-user-card__header-data">
                     <a href="/ru/users/Anna_sokol22/" class="tm-user-card__userpic tm-user-card__userpic_size-40">
                      <div class="tm-entity-image">
                       <img alt="" src="//habrastorage.org/getpro/habr/avatars/8a0/768/a4b/8a0768a4b3e1a9fdcddae1bb0d0b5ee2.jpg" class="tm-entity-image__pic">
                      </div></a> 
                     <div class="tm-user-card__meta">
                      <div title=" 105 голосов " class="tm-counter-container tm-karma tm-karma">
                       <div class="tm-counter-container__header">
                        <div class="tm-karma__votes tm-karma__votes_positive">
                          13 
                        </div>
                       </div> 
                       <div class="tm-counter-container__footer">
                        <div class="tm-karma__text">
                          Карма 
                        </div> 
                        <div class="v-portal" style="display:none;"></div>
                       </div>
                      </div> 
                      <div title="Рейтинг пользователя" class="tm-counter-container">
                       <div class="tm-counter-container__header"> 
                        <div class="tm-votes-lever tm-votes-lever tm-votes-lever_appearance-rating">
                         <!----> 
                         <div class="tm-votes-lever__score tm-votes-lever__score tm-votes-lever__score_appearance-rating">
                          <span class="tm-votes-lever__score-counter tm-votes-lever__score-counter tm-votes-lever__score-counter_rating"> 37.8 </span>
                         </div> <!---->
                        </div>
                       </div> 
                       <div class="tm-counter-container__footer">
                        <span class="tm-rating__text tm-rating__text"> Рейтинг </span>
                       </div>
                      </div>
                     </div>
                    </div>
                   </div> 
                   <div class="tm-user-card__info tm-user-card__info tm-user-card__info_variant-article">
                    <div class="tm-user-card__title tm-user-card__title tm-user-card__title_variant-article">
                     <span class="tm-user-card__name tm-user-card__name tm-user-card__name_variant-article">Аня Сокол</span> <a href="/ru/users/Anna_sokol22/" class="tm-user-card__nickname tm-user-card__nickname tm-user-card__nickname_variant-article"> @Anna_sokol22 </a> <!---->
                    </div> 
                    <p class="tm-user-card__short-info tm-user-card__short-info tm-user-card__short-info_variant-article">Пользователь</p>
                   </div>
                  </div> 
                  <div class="tm-user-card__buttons tm-user-card__buttons tm-user-card__buttons_variant-article">
                   <!----> <!----> <!----> <!----> <!---->
                  </div>
                 </div> <!---->
                </div> 
                <div class="v-portal" style="display:none;"></div>
               </div> <!---->
              </section> 
              <div class="tm-article-blocks__comments">
               <div class="tm-article-page-comments">
                <div class="tm-article-comments-counter-link tm-article-comments-counter-button">
                 <a href="/ru/companies/southbridge/articles/727510/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style">
                  <svg height="24" width="24" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted">
                   <title>Комментарии</title> <use xlink:href="/img/megazord-v28.c350aa68..svg#counter-comments"></use>
                  </svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted"> Комментировать </span></a> <!---->
                </div>
               </div>
              </div> 
              <section class="tm-block tm-block tm-block_spacing-bottom">
               <header class="tm-block__header tm-block__header tm-block__header_variant-borderless">
                <div class="tm-block__header-container">
                 <h2 class="tm-block__title tm-block__title tm-block__title_variant-large">Публикации</h2> 
                </div> <!---->
               </header> 
               <div class="tm-block__body tm-block__body tm-block__body_variant-condensed-slim">
                <div class="tm-tabs tm-tabs">
                 <div>
                  <span class="tm-tabs__tab-item"><button class="tm-tabs__tab-link tm-tabs__tab-link tm-tabs__tab-link_active tm-tabs__tab-link_slim"> Лучшие за сутки </button></span><span class="tm-tabs__tab-item"><button class="tm-tabs__tab-link tm-tabs__tab-link tm-tabs__tab-link_slim"> Похожие </button></span>
                 </div> <!---->
                </div> 
                <div class="similar-and-daily__tab-view">
                 <div class="placeholder-wrapper">
                  <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> 
                  <div class="tm-placeholder-article-cards">
                   <div class="tm-placeholder-article-card">
                    <div class="tm-placeholder__user">
                     <div class="tm-placeholder__user-pic loads"></div> 
                     <div class="tm-placeholder__user-date loads"></div>
                    </div> 
                    <div class="tm-placeholder-article-card__title">
                     <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div> 
                     <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div>
                    </div> 
                    <div class="tm-placeholder-article-card__icons tm-placeholder__counters">
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                    </div>
                   </div>
                   <div class="tm-placeholder-article-card">
                    <div class="tm-placeholder__user">
                     <div class="tm-placeholder__user-pic loads"></div> 
                     <div class="tm-placeholder__user-date loads"></div>
                    </div> 
                    <div class="tm-placeholder-article-card__title">
                     <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div> 
                     <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div>
                    </div> 
                    <div class="tm-placeholder-article-card__icons tm-placeholder__counters">
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                    </div>
                   </div>
                   <div class="tm-placeholder-article-card">
                    <div class="tm-placeholder__user">
                     <div class="tm-placeholder__user-pic loads"></div> 
                     <div class="tm-placeholder__user-date loads"></div>
                    </div> 
                    <div class="tm-placeholder-article-card__title">
                     <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div> 
                     <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div>
                    </div> 
                    <div class="tm-placeholder-article-card__icons tm-placeholder__counters">
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                    </div>
                   </div>
                   <div class="tm-placeholder-article-card">
                    <div class="tm-placeholder__user">
                     <div class="tm-placeholder__user-pic loads"></div> 
                     <div class="tm-placeholder__user-date loads"></div>
                    </div> 
                    <div class="tm-placeholder-article-card__title">
                     <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div> 
                     <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div>
                    </div> 
                    <div class="tm-placeholder-article-card__icons tm-placeholder__counters">
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                    </div>
                   </div>
                   <div class="tm-placeholder-article-card">
                    <div class="tm-placeholder__user">
                     <div class="tm-placeholder__user-pic loads"></div> 
                     <div class="tm-placeholder__user-date loads"></div>
                    </div> 
                    <div class="tm-placeholder-article-card__title">
                     <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div> 
                     <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div>
                    </div> 
                    <div class="tm-placeholder-article-card__icons tm-placeholder__counters">
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                     <div class="tm-placeholder-data-icon">
                      <div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> 
                      <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div>
                     </div>
                    </div>
                   </div>
                  </div> <!----> <!----> <!----> <!---->
                 </div> <!---->
                </div>
               </div> <!---->
              </section> 
              <div class="placeholder-wrapper">
               <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> 
               <div class="tm-placeholder-inset tm-placeholder-vacancies">
                <div class="tm-placeholder-inset__header">
                 <div class="tm-placeholder__line tm-placeholder__line_inset-header loads"></div>
                </div> 
                <div class="tm-placeholder-inset__body">
                 <ul class="tm-placeholder-list">
                  <li class="tm-placeholder-list__item tm-placeholder-list__item_inset">
                   <div class="tm-placeholder-list__title-container">
                    <div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div>
                   </div> 
                   <div class="tm-project-block-items__properties">
                    <span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span>
                   </div></li>
                  <li class="tm-placeholder-list__item tm-placeholder-list__item_inset">
                   <div class="tm-placeholder-list__title-container">
                    <div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div>
                   </div> 
                   <div class="tm-project-block-items__properties">
                    <span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span>
                   </div></li>
                  <li class="tm-placeholder-list__item tm-placeholder-list__item_inset">
                   <div class="tm-placeholder-list__title-container">
                    <div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div>
                   </div> 
                   <div class="tm-project-block-items__properties">
                    <span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span>
                   </div></li>
                  <li class="tm-placeholder-list__item tm-placeholder-list__item_inset">
                   <div class="tm-placeholder-list__title-container">
                    <div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div>
                   </div> 
                   <div class="tm-project-block-items__properties">
                    <span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span>
                   </div></li>
                  <li class="tm-placeholder-list__item tm-placeholder-list__item_inset">
                   <div class="tm-placeholder-list__title-container">
                    <div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div>
                   </div> 
                   <div class="tm-project-block-items__properties">
                    <span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span>
                   </div></li>
                 </ul>
                </div> 
                <div class="tm-placeholder-inset__footer">
                 <div class="tm-placeholder__line tm-placeholder__line_inset-footer loads"></div>
                </div>
               </div> <!----> <!----> <!----> <!----> <!----> <!---->
              </div> <!----> 
             </div>
            </div>
           </div>
          </div>
         </div> 
         <div class="tm-page__sidebar">
          <div class="tm-layout-sidebar">
           <div class="tm-layout-sidebar__placeholder_initial"></div> 
           <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;">
            <!----> 
            <section class="tm-block tm-block tm-block_spacing-bottom">
             <header class="tm-block__header tm-block__header">
              <div class="tm-block__header-container">
               <h2 class="tm-block__title tm-block__title">Информация</h2> 
              </div> <!---->
             </header> 
             <div class="tm-block__body tm-block__body">
              <div class="tm-company-basic-info">
               <dl class="tm-description-list tm-description-list tm-description-list_variant-columns-nowrap">
                <dt class="tm-description-list__title tm-description-list__title tm-description-list__title_variant-columns-nowrap">
                 Сайт
                </dt> 
                <dd class="tm-description-list__body tm-description-list__body tm-description-list__body_variant-columns-nowrap">
                 <a href="https://southbridge.io" target="_blank" class="tm-company-basic-info__link"> southbridge.io </a>
                </dd>
               </dl> 
               <dl class="tm-description-list tm-description-list tm-description-list_variant-columns-nowrap">
                <dt class="tm-description-list__title tm-description-list__title tm-description-list__title_variant-columns-nowrap">
                 Дата регистрации
                </dt> 
                <dd class="tm-description-list__body tm-description-list__body tm-description-list__body_variant-columns-nowrap">
                 <time datetime="2012-11-15T08:41:16.000Z" title="2012-11-15, 12:41">15 ноября 2012</time>
                </dd>
               </dl> 
               <dl class="tm-description-list tm-description-list tm-description-list_variant-columns-nowrap">
                <dt class="tm-description-list__title tm-description-list__title tm-description-list__title_variant-columns-nowrap">
                 Дата основания
                </dt> 
                <dd class="tm-description-list__body tm-description-list__body tm-description-list__body_variant-columns-nowrap">
                 <time datetime="2008-02-21T21:00:00.000Z" title="2008-02-22, 00:00">22 февраля 2008</time>
                </dd>
               </dl> 
               <dl class="tm-description-list tm-description-list tm-description-list_variant-columns-nowrap">
                <dt class="tm-description-list__title tm-description-list__title tm-description-list__title_variant-columns-nowrap">
                 Численность
                </dt> 
                <dd class="tm-description-list__body tm-description-list__body tm-description-list__body_variant-columns-nowrap">
                  51–100 человек 
                </dd>
               </dl> 
               <dl class="tm-description-list tm-description-list tm-description-list_variant-columns-nowrap">
                <dt class="tm-description-list__title tm-description-list__title tm-description-list__title_variant-columns-nowrap">
                 Местоположение
                </dt> 
                <dd class="tm-description-list__body tm-description-list__body tm-description-list__body_variant-columns-nowrap">
                  Россия 
                </dd>
               </dl> 
               <dl class="tm-description-list tm-description-list tm-description-list_variant-columns-nowrap">
                <dt class="tm-description-list__title tm-description-list__title tm-description-list__title_variant-columns-nowrap">
                 Представитель
                </dt> 
                <dd class="tm-description-list__body tm-description-list__body tm-description-list__body_variant-columns-nowrap">
                 <a href="/ru/users/aSkobin/" class="tm-company-basic-info__link"> Антон Скобин </a>
                </dd>
               </dl>
              </div>
             </div> <!---->
            </section> 
            <div class="tm-company-widgets"></div> <!----> <!----> <!---->
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </main> <!---->
    </div> 
    <div class="tm-footer-menu">
     <div class="tm-page-width">
      <div class="tm-footer-menu__container">
       <div class="tm-footer-menu__block">
        <p class="tm-footer-menu__block-title"> Ваш аккаунт </p> 
        <div class="tm-footer-menu__block-content">
         <ul class="tm-footer-menu__list">
          <li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/companies/southbridge/articles/727510/&amp;hl=ru" rel="nofollow" target="_self"> Войти </a></li>
          <li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/companies/southbridge/articles/727510/&amp;hl=ru" rel="nofollow" target="_self"> Регистрация </a></li>
         </ul>
        </div>
       </div>
       <div class="tm-footer-menu__block">
        <p class="tm-footer-menu__block-title"> Разделы </p> 
        <div class="tm-footer-menu__block-content">
         <ul class="tm-footer-menu__list">
          <li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active"> Статьи </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link"> Новости </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link"> Хабы </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link router-link-active"> Компании </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link"> Авторы </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link"> Песочница </a></li>
         </ul>
        </div>
       </div>
       <div class="tm-footer-menu__block">
        <p class="tm-footer-menu__block-title"> Информация </p> 
        <div class="tm-footer-menu__block-content">
         <ul class="tm-footer-menu__list">
          <li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link"> Устройство сайта </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link"> Для авторов </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link"> Для компаний </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link"> Документы </a></li>
          <li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank"> Соглашение </a></li>
          <li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank"> Конфиденциальность </a></li>
         </ul>
        </div>
       </div>
       <div class="tm-footer-menu__block">
        <p class="tm-footer-menu__block-title"> Услуги </p> 
        <div class="tm-footer-menu__block-content">
         <ul class="tm-footer-menu__list">
          <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/corporate-blogs/" target="_blank"> Корпоративный блог </a></li>
          <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/advertising/" target="_blank"> Медийная реклама </a></li>
          <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/native-special/" target="_blank"> Нативные проекты </a></li>
          <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/education-programs/" target="_blank"> Образовательные программы </a></li>
          <li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/hello-startup/" target="_blank"> Стартапам </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/specials/" class="footer-menu__item-link"> Спецпроекты </a></li>
         </ul>
        </div>
       </div>
      </div>
     </div>
    </div> 
    <div class="tm-footer">
     <div class="tm-page-width">
      <div class="tm-footer__container">
       <!----> 
       <div class="tm-footer__social">
        <a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon">
         <svg height="16" width="16" class="tm-svg-img tm-svg-icon">
          <title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use>
         </svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon">
         <svg height="16" width="16" class="tm-svg-img tm-svg-icon">
          <title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use>
         </svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon">
         <svg height="16" width="16" class="tm-svg-img tm-svg-icon">
          <title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use>
         </svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon">
         <svg height="16" width="16" class="tm-svg-img tm-svg-icon">
          <title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use>
         </svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon">
         <svg height="16" width="16" class="tm-svg-img tm-svg-icon">
          <title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use>
         </svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon">
         <svg height="16" width="16" class="tm-svg-img tm-svg-icon">
          <title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use>
         </svg></a>
       </div> 
       <div class="v-portal" style="display:none;"></div> <button class="tm-footer__link"><!----> Настройка языка </button> <a href="/ru/feedback/" class="tm-footer__link"> Техническая поддержка </a> <a href="/berserk-mode-nope" class="tm-footer__link"> Вернуться на старую версию </a> 
       <div class="tm-footer-copyright">
        <span class="tm-copyright"><span class="tm-copyright__years">© 2006–2023, </span> <span class="tm-copyright__name"><a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a></span></span>
       </div>
      </div>
     </div>
    </div> <!----> <!---->
   </div> 
   <div class="vue-portal-target"></div>
  </div> 
  <script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"727510":{"id":"727510","timePublished":"2023-04-07T13:02:21+00:00","isCorporative":true,"lang":"ru","titleHtml":"Мир приключений по API-серверу Kubernetes. Часть 2. Наблюдение и кэширование","leadData":{"textHtml":"\u003Cp\u003EВ нашей предыдущей статье про приключения сервера Kubernetes API мы рассмотрели интерфейс хранилища и исследовали единственную реализацию в дереве: etcd3. Однако внимательное прочтение сносок в этом посте показало, что мы были не совсем честными, говоря, что etcd3 — единственная реализация.\u003C\u002Fp\u003E\u003Cp\u003EЭто можно оспорить, ведь Cacher также может быть технической реализацией, хотя ему и требуется базовая реализация. Подробно рассмотрим кэширование в одном из будущих постов. А сейчас подробно изучим кэширование и его возможности.&nbsp;\u003C\u002Fp\u003E\u003Cp\u003E\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F446\u002F913\u002Fa17\u002F446913a171b09a149098ae918196b04b.png","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F446\u002F913\u002Fa17\u002F446913a171b09a149098ae918196b04b.png","fit":"cover","positionY":0,"positionX":0}},"editorVersion":"2.0","postType":"article","postLabels":[{"type":"translation","data":{"originalAuthorName":"DANIEL MANGUM","originalUrl":"https:\u002F\u002Fdanielmangum.com\u002Fposts\u002Fk8s-asa-watching-and-caching\u002F"}}],"author":{"id":"2870007","alias":"Anna_sokol22","fullname":"Аня Сокол","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F8a0\u002F768\u002Fa4b\u002F8a0768a4b3e1a9fdcddae1bb0d0b5ee2.jpg","speciality":null,"scoreStats":{"score":13,"votesCount":105},"rating":37.8,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null}},"statistics":{"commentsCount":0,"favoritesCount":13,"readingCount":381,"score":6,"votesCount":6,"votesCountPlus":6,"votesCountMinus":0},"hubs":[{"id":"17901","alias":"southbridge","type":"corporative","title":"Блог компании Southbridge","titleHtml":"Блог компании Southbridge","isProfiled":false,"relatedData":null},{"id":"6398","alias":"it-infrastructure","type":"collective","title":"IT-инфраструктура","titleHtml":"IT-инфраструктура","isProfiled":true,"relatedData":null},{"id":"20788","alias":"devops","type":"collective","title":"DevOps","titleHtml":"DevOps","isProfiled":true,"relatedData":null},{"id":"22196","alias":"kubernetes","type":"collective","title":"Kubernetes","titleHtml":"Kubernetes","isProfiled":true,"relatedData":null}],"flows":[{"id":"1","alias":"develop","title":"Разработка","titleHtml":"Разработка"},{"id":"6","alias":"admin","title":"Администрирование","titleHtml":"Администрирование"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F446\u002F913\u002Fa17\u002F446913a171b09a149098ae918196b04b.png\" width=\"1080\" height=\"609\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F446\u002F913\u002Fa17\u002F446913a171b09a149098ae918196b04b.png\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВ нашей предыдущей статье про приключения сервера Kubernetes API мы рассмотрели интерфейс хранилища и исследовали единственную реализацию в дереве: etcd3. Однако внимательное прочтение сносок в этом посте показало, что мы были не совсем честными, говоря, что etcd3 — единственная реализация.\u003C\u002Fp\u003E\u003Cp\u003EЭто можно оспорить, ведь Cacher также может быть технической реализацией, хотя ему и требуется базовая реализация. Подробно рассмотрим кэширование в одном из будущих постов. А сейчас подробно изучим кэширование и его возможности. \u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F934\u002F15e\u002F43f\u002F93415e43f565a17db6ed85ce047607db.png\" width=\"1920\" height=\"1080\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F934\u002F15e\u002F43f\u002F93415e43f565a17db6ed85ce047607db.png\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003E\u003Cstrong\u003EО чём поговорим в статье:\u003C\u002Fstrong\u003E \u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003EНаблюдение (👈 «Я хочу проблему и ее решение»);\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EВсе смотрят;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EКэширование (👈 «Мне просто нужно решение»);\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EwatchCache \u003C\u002Fcode\u003E;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EcacherListerWatcher \u003C\u002Fcode\u003E;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EReflector\u003C\u002Fcode\u003E;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EСвяжем всё вместе; \u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EМетод \u003Ccode\u003E Watch()\u003C\u002Fcode\u003E;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EВсе смотрят… Успешно (👈 «Просто покажите мне код»).\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Ch2\u003EНаблюдение\u003C\u002Fh2\u003E\u003Cp\u003EПрежде чем мы введем какой-либо тип кэширования, стоит вернуться к тому факту, что \u003Ccode\u003Estorage.Interface\u003C\u002Fcode\u003E включает в себя метод \u003Ccode\u003EWatch\u003C\u002Fcode\u003E, реализация \u003Ccode\u003Eetcd3\u003C\u002Fcode\u003E \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fkubernetes\u002Fkubernetes\u002Fblob\u002F3154010eec3488dd64110e3ca6c4ba0b5ac61310\u002Fstaging\u002Fsrc\u002Fk8s.io\u002Fapiserver\u002Fpkg\u002Fstoraghttps:\u002F\u002Fgithub.com\u002Fkubernetes\u002Fkubernetes\u002Fblob\u002F3154010eec3488dd64110e3ca6c4ba0b5ac61310\u002Fstaging\u002Fsrc\u002Fk8s.io\u002Fapiserver\u002Fpkg\u002Fstorage\u002Fetcd3\u002Fstore.go#L847e\u002Fetcd3\u002Fstore.go#L847\"\u003E\u003Cu\u003Eподдерживает его\u003C\u002Fu\u003E\u003C\u002Fa\u003E. Ранее \u003Ca href=\"https:\u002F\u002Fdanielmangum.com\u002Fposts\u002Fk8s-asa-the-storage-interface\u002F#our-good-friend-etcd\"\u003E\u003Cu\u003Eмы изучали\u003C\u002Fu\u003E\u003C\u002Fa\u003E возможность отслеживания изменений, обращаясь непосредственно к \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E с помощью \u003Ccode\u003Eetcdctl\u003C\u002Fcode\u003E. \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E предлагает \u003Ca href=\"https:\u002F\u002Fetcd.io\u002Fdocs\u002Fv3.5\u002Flearning\u002Fapi\u002F#watch-api\"\u003E\u003Cu\u003EWatch API\u003C\u002Fu\u003E\u003C\u002Fa\u003E, который использует двунаправленные потоки gRPC для доставки событий клиентам при изменении значения для \u003Ca href=\"https:\u002F\u002Fgrpc.io\u002Fdocs\u002Fwhat-is-grpc\u002Fcore-concepts\u002F#bidirectional-streaming-rpc\"\u003E\u003Cu\u003Eключа\u003C\u002Fu\u003E\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cp\u003EРеализация etcd3 Watch \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fkubernetes\u002Fkubernetes\u002Fblob\u002F3154010eec3488dd64110e3ca6c4ba0b5ac61310\u002Fstaging\u002Fsrc\u002Fk8s.io\u002Fapiserver\u002Fpkg\u002Fstorage\u002Fetcd3\u002Fstore.go#L856\"\u003E\u003Cu\u003Eсоздает \u003C\u002Fu\u003E\u003C\u002Fa\u003E\u003Ccode\u003Ewatch.Interface\u003C\u002Fcode\u003E, поддерживаемый \u003Ccode\u003Ewatcher\u003C\u002Fcode\u003E. Новый \u003Ccode\u003Ewatcher\u003C\u002Fcode\u003E создается при каждом вызове \u003Ccode\u003EWatch\u003C\u002Fcode\u003E, и каждый \u003Ccode\u003Ewatcher\u003C\u002Fcode\u003E, по сути, просто вызывает \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E Watch API и пересылает события по каналу.\u003C\u002Fp\u003E\u003Cp\u003EДавайте возьмем нашу программу из \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fcompanies\u002Fsouthbridge\u002Farticles\u002F727470\u002F\"\u003E\u003Cu\u003Eпредыдущего поста\u003C\u002Fu\u003E\u003C\u002Fa\u003E и модифицируем её, чтобы отслеживать изменения во всех \u003Ccode\u003EConfigMaps\u003C\u002Fcode\u003E в кластере.\u003C\u002Fp\u003E\u003Cp\u003EВы можете найти инструкции о том, как получить данные PCI, необходимые для связи с \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E в кластере \u003Ccode\u003Ekind\u003C\u002Fcode\u003E, \u003Ca href=\"https:\u002F\u002Fdanielmangum.com\u002Fposts\u002Fk8s-asa-the-storage-interface\u002F#calling-the-storageinterface-directly\"\u003E\u003Cu\u003Eздесь\u003C\u002Fu\u003E\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Edirectwatch.go\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Epackage main\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\n\t\"go.etcd.io\u002Fetcd\u002Fclient\u002Fpkg\u002Fv3\u002Ftransport\"\n\tclientv3 \"go.etcd.io\u002Fetcd\u002Fclient\u002Fv3\"\n\tv1 \"k8s.io\u002Fapi\u002Fcore\u002Fv1\"\n\t\"k8s.io\u002Fapimachinery\u002Fpkg\u002Fruntime\"\n\t\"k8s.io\u002Fapimachinery\u002Fpkg\u002Fruntime\u002Fserializer\"\n\t\"k8s.io\u002Fapiserver\u002Fpkg\u002Fstorage\"\n\t\"k8s.io\u002Fapiserver\u002Fpkg\u002Fstorage\u002Fetcd3\"\n\t\"k8s.io\u002Fapiserver\u002Fpkg\u002Fstorage\u002Fvalue\u002Fencrypt\u002Fidentity\"\n\t\"k8s.io\u002Fkubernetes\u002Fpkg\u002Fapis\u002Fcore\"\n\tk8sv1 \"k8s.io\u002Fkubernetes\u002Fpkg\u002Fapis\u002Fcore\u002Fv1\"\n)\n\nfunc main() {\n\ttlsConfig, err := (transport.TLSInfo{\n\t\tCertFile:       \".\u002Fpki\u002Fetcd\u002Fserver.crt\",\n\t\tKeyFile:        \".\u002Fpki\u002Fetcd\u002Fserver.key\",\n\t\tTrustedCAFile:  \".\u002Fpki\u002Fetcd\u002Fca.crt\",\n\t\tClientCertFile: \".\u002Fpki\u002Fapiserver-etcd-client.crt\",\n\t\tClientKeyFile:  \".\u002Fpki\u002Fapiserver-etcd-client.key\",\n\t}).ClientConfig()\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tc, err := clientv3.New(clientv3.Config{\n\t\tEndpoints: []string{\"https:\u002F\u002F127.0.0.1:2379\"},\n\t\tTLS:       tlsConfig,\n\t})\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\n\tscheme := runtime.NewScheme()\n\tk8sv1.AddToScheme(scheme)\n\tcore.AddToScheme(scheme)\n\tf := serializer.NewCodecFactory(scheme)\n\ts := etcd3.New(c, f.CodecForVersions(nil, f.UniversalDecoder(), nil, k8sv1.SchemeGroupVersion), nil, \"registry\", v1.Resource(\"ConfigMap\"), identity.NewEncryptCheckTransformer(), true, etcd3.NewDefaultLeaseManagerConfig())\n\tw, err := s.Watch(context.Background(), \"configmaps\", storage.ListOptions{\n\t\tPredicate: storage.Everything,\n\t\tRecursive: true,\n\t})\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfor e := range w.ResultChan() {\n\t\tco, ok := e.Object.(*v1.ConfigMap)\n\t\tif !ok {\n\t\t\tpanic(\"not a config map!\")\n\t\t}\n\t\tfmt.Printf(\"%s || %s\u002F%s\\n\", e.Type, co.Namespace, co.Name)\n\t}\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EОбратите внимание на тот факт, что мы регистрируем типы из \u003Ccode\u003Ek8s.io\u002Fkubernetes\u003C\u002Fcode\u003E скорее, чем \u003Ccode\u003Ek8s.io\u002Fapi\u003C\u002Fcode\u003E. Это нужно, чтобы выполнить преобразование \u003Ccode\u003Einternal\u003C\u002Fcode\u003E версии в нашу желаемую версию (\u003Ccode\u003Ev1\u003C\u002Fcode\u003E). Мы также передаем \u003Ccode\u003Enil  CodecForVersions,\u003C\u002Fcode\u003E поскольку декодируем их только при чтении событий потока.\u003C\u002Fp\u003E\u003Cp\u003EЕсли у вас запущен кластер \u003Ccode\u003Ekind\u003C\u002Fcode\u003E, вы можете начать перенаправление портов \u003Ccode\u003Eetcd Pod\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E$ kubectl port-forward -n kube-system pod\u002Fetcd-kind-control-plane 2379:2379\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EТеперь мы можем начать нашу программу.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E$ go run directwatch.go\nADDED || default\u002Fkube-root-ca.crt\nADDED || kube-node-lease\u002Fkube-root-ca.crt\nADDED || kube-public\u002Fcluster-info\nADDED || kube-public\u002Fkube-root-ca.crt\nADDED || kube-system\u002Fcoredns\nADDED || kube-system\u002Fextension-apiserver-authentication\nADDED || kube-system\u002Fkube-proxy\nADDED || kube-system\u002Fkube-root-ca.crt\nADDED || kube-system\u002Fkubeadm-config\nADDED || kube-system\u002Fkubelet-config\nADDED || local-path-storage\u002Fkube-root-ca.crt\nADDED || local-path-storage\u002Flocal-path-config\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EКак и ожидалось, мы получаем \u003Ccode\u003EADDED\u003C\u002Fcode\u003E события для всех \u003Ccode\u003EConfigMaps\u003C\u002Fcode\u003E, находящихся в данный момент в кластере. Можно создавать, обновлять и удалять \u003Ccode\u003EConfigMap\u003C\u002Fcode\u003E, чтобы увидеть, как другие события отражаются в потоке просмотра.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E$ kubectl create configmap k8s-asa --from-literal hello=world\nconfigmap\u002Fk8s-asa created\n\n$ kubectl create configmap k8s-asa --from-literal hello=asa -o yaml --dry-run | kubectl apply -f -\nconfigmap\u002Fk8s-asa configured\n\n$ kubectl delete configmap k8s-asa\nconfigmap \"k8s-asa\" deleted\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПосмотрим на каждое из этих событий в потоке просмотра с соответствующим типом.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003EADDED || default\u002Fk8s-asa\nMODIFIED || default\u002Fk8s-asa\nDELETED || default\u002Fk8s-asa\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Ch2\u003EОбщее наблюдение\u003C\u002Fh2\u003E\u003Cp\u003EТеперь мы можем получать события в любое время, когда меняется интересующий нас тип, и не похоже, что \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E или наша маленькая программа сильно «потеют». Но давайте взглянем на некоторые показатели \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E, чтобы убедиться в этом. Мы можем найти открытый адрес метрик для \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E в нашем кластере \u003Ccode\u003Ekind\u003C\u002Fcode\u003E, просмотрев команду для контейнера в модуле \u003Ccode\u003EPod\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E$ kubectl get pod -n kube-system etcd-kind-control-plane -o=jsonpath={.spec.containers[0].command} | jq .\n\n[\n  \"etcd\",\n  \"--advertise-client-urls=https:\u002F\u002F172.19.0.2:2379\",\n  \"--cert-file=\u002Fetc\u002Fkubernetes\u002Fpki\u002Fetcd\u002Fserver.crt\",\n  \"--client-cert-auth=true\",\n  \"--data-dir=\u002Fvar\u002Flib\u002Fetcd\",\n  \"--experimental-initial-corrupt-check=true\",\n  \"--experimental-watch-progress-notify-interval=5s\",\n  \"--initial-advertise-peer-urls=https:\u002F\u002F172.19.0.2:2380\",\n  \"--initial-cluster=kind-control-plane=https:\u002F\u002F172.19.0.2:2380\",\n  \"--key-file=\u002Fetc\u002Fkubernetes\u002Fpki\u002Fetcd\u002Fserver.key\",\n  \"--listen-client-urls=https:\u002F\u002F127.0.0.1:2379,https:\u002F\u002F172.19.0.2:2379\",\n  \"--listen-metrics-urls=http:\u002F\u002F127.0.0.1:2381\",\n  \"--listen-peer-urls=https:\u002F\u002F172.19.0.2:2380\",\n  \"--name=kind-control-plane\",\n  \"--peer-cert-file=\u002Fetc\u002Fkubernetes\u002Fpki\u002Fetcd\u002Fpeer.crt\",\n  \"--peer-client-cert-auth=true\",\n  \"--peer-key-file=\u002Fetc\u002Fkubernetes\u002Fpki\u002Fetcd\u002Fpeer.key\",\n  \"--peer-trusted-ca-file=\u002Fetc\u002Fkubernetes\u002Fpki\u002Fetcd\u002Fca.crt\",\n  \"--snapshot-count=10000\",\n  \"--trusted-ca-file=\u002Fetc\u002Fkubernetes\u002Fpki\u002Fetcd\u002Fca.crt\"\n]\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003E\u003Ccode\u003E--listen-metrics-urls\u003C\u002Fcode\u003E  — то, что мы ищем .\u003Ccode\u003Eetcd\u003C\u002Fcode\u003E будет обслуживать \u003Ca href=\"https:\u002F\u002Fdanielmangum.com\u002Fposts\u002Fk8s-asa-watching-and-caching\u002F\"\u003E\u003Cu\u003Eпоказатели \u003C\u002Fu\u003E\u003C\u002Fa\u003EPrometheus в конечной точке \u003Ccode\u003E\u002Fmetrics\u003C\u002Fcode\u003E по этому адресу. Создаём минимальный конфигурационный файл Prometheus, чтобы дать команду сборщику выполнить очистку \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Eprometheus.yml\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Eglobal:\n  scrape_interval: 1s\nscrape_configs:\n  - job_name: etcd\n    static_configs:\n    - targets: ['127.0.0.1:2379']\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПрежде чем мы запустим Prometheus, убедитесь, что можно получить доступ к конечной точке \u003Ccode\u003Eetcd metrics\u003C\u002Fcode\u003E. Перенаправление портов в пространство имен \u003Ccode\u003Ehost network\u003C\u002Fcode\u003E позволит запускать Prometheus в пространстве имен \u003Ccode\u003Ehost network\u003C\u002Fcode\u003E, что упрощает доступ к панели мониторинга в браузере.\u003C\u002Fp\u003E\u003Cp\u003EПеренесите конечную точку \u003Ccode\u003Eetcd metrics\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E$ kubectl port-forward -n kube-system pod\u002Fetcd-kind-control-plane 2381:2381\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EЗатем запустите контейнер Prometheus, подключённый к сети хоста.  \u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E$ docker run --net=host --rm -v $(pwd)\u002Fprometheus.yml:\u002Fetc\u002Fprometheus\u002Fprometheus.yml prom\u002Fprometheus\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПанель мониторинга Prometheus теперь должна быть доступна в браузере по адресу \u003Ccode\u003E127.0.0.1:9090\u003C\u002Fcode\u003E. Мы можем получить график показателей, которые предоставляет \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E, введя запрос. Например, \u003Ccode\u003Eirate(process_cpu_seconds_total{job=\"etcd\"}[5m])\u003C\u002Fcode\u003E покажет скорость увеличения общего системного и пользовательского процессорного времени. Если запустить программу сейчас, которая устанавливает просмотры для \u003Ccode\u003EConfigMaps\u003C\u002Fcode\u003E, мы не увидим существенного влияния на процессор.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3a1\u002Fe4c\u002Fb70\u002F3a1e4cb705e9372e9e24451daed74cf6.png\" width=\"3836\" height=\"2000\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3a1\u002Fe4c\u002Fb70\u002F3a1e4cb705e9372e9e24451daed74cf6.png\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EДиапазон по оси Y составляет от \u003Ccode\u003E0.03\u003C\u002Fcode\u003E\u003Cem\u003E до \u003C\u002Fem\u003E\u003Ccode\u003E0.23\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EПримечание:\u003C\u002Fstrong\u003E Поскольку мы запускаем \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E в кластере \u003Ccode\u003Ekind\u003C\u002Fcode\u003E, сервер API Kubernetes и другие компоненты взаимодействуют с ним в дополнение к нагрузке от программы.\u003C\u002Fp\u003E\u003Cp\u003EЭтого и следовало ожидать: одни часы вряд ли окажут существенное влияние. Но если мы увеличим количество часов, то начнем сталкиваться с проблемами. Давайте настроим нашу программу так, чтобы она запускала 10 000 просмотров на \u003Ccode\u003EConfigMaps\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Emanydirectwatch.go\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Epackage main\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"os\"\n\t\"os\u002Fsignal\"\n\n\t\"go.etcd.io\u002Fetcd\u002Fclient\u002Fpkg\u002Fv3\u002Ftransport\"\n\tclientv3 \"go.etcd.io\u002Fetcd\u002Fclient\u002Fv3\"\n\tv1 \"k8s.io\u002Fapi\u002Fcore\u002Fv1\"\n\t\"k8s.io\u002Fapimachinery\u002Fpkg\u002Fruntime\"\n\t\"k8s.io\u002Fapimachinery\u002Fpkg\u002Fruntime\u002Fserializer\"\n\t\"k8s.io\u002Fapiserver\u002Fpkg\u002Fstorage\"\n\t\"k8s.io\u002Fapiserver\u002Fpkg\u002Fstorage\u002Fetcd3\"\n\t\"k8s.io\u002Fapiserver\u002Fpkg\u002Fstorage\u002Fvalue\u002Fencrypt\u002Fidentity\"\n\t\"k8s.io\u002Fkubernetes\u002Fpkg\u002Fapis\u002Fcore\"\n\tk8sv1 \"k8s.io\u002Fkubernetes\u002Fpkg\u002Fapis\u002Fcore\u002Fv1\"\n)\n\nfunc main() {\n\ttlsConfig, err := (transport.TLSInfo{\n\t\tCertFile:       \".\u002Fpki\u002Fetcd\u002Fserver.crt\",\n\t\tKeyFile:        \".\u002Fpki\u002Fetcd\u002Fserver.key\",\n\t\tTrustedCAFile:  \".\u002Fpki\u002Fetcd\u002Fca.crt\",\n\t\tClientCertFile: \".\u002Fpki\u002Fapiserver-etcd-client.crt\",\n\t\tClientKeyFile:  \".\u002Fpki\u002Fapiserver-etcd-client.key\",\n\t}).ClientConfig()\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tc, err := clientv3.New(clientv3.Config{\n\t\tEndpoints: []string{\"https:\u002F\u002F127.0.0.1:2379\"},\n\t\tTLS:       tlsConfig,\n\t})\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\n\tscheme := runtime.NewScheme()\n\tk8sv1.AddToScheme(scheme)\n\tcore.AddToScheme(scheme)\n\tf := serializer.NewCodecFactory(scheme)\n\ts := etcd3.New(c, f.CodecForVersions(nil, f.UniversalDecoder(), nil, k8sv1.SchemeGroupVersion), nil, \"registry\", v1.Resource(\"ConfigMap\"), identity.NewEncryptCheckTransformer(), true, etcd3.NewDefaultLeaseManagerConfig())\n\tfor i := 0; i &lt; 10000; i++ {\n\t\tw, err := s.Watch(context.Background(), \"configmaps\", storage.ListOptions{\n\t\t\tPredicate: storage.Everything,\n\t\t\tRecursive: true,\n\t\t})\n\t\tif err != nil {\n\t\t\tpanic(err)\n\t\t}\n\t\tgo func() {\n\t\t\tfor e := range w.ResultChan() {\n\t\t\t\tco, ok := e.Object.(*v1.ConfigMap)\n\t\t\t\tif !ok {\n\t\t\t\t\tpanic(\"not a config map!\")\n\t\t\t\t}\n\t\t\t\tfmt.Printf(\"%s || %s\u002F%s\\n\", e.Type, co.Namespace, co.Name)\n\t\t\t}\n\t\t}()\n\t}\n\n\tstop := make(chan os.Signal)\n\tsignal.Notify(stop, os.Interrupt)\n\t&lt;-stop\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EЕсли мы запустим программу сейчас, то должны увидеть, что все 10 000 просмотров получают список всех \u003Ccode\u003EConfigMaps\u003C\u002Fcode\u003E в кластере. Когда создадим новую \u003Ccode\u003EConfigMap\u003C\u002Fcode\u003E, мы сможем увидеть, что все часы получают уведомления.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E$ go run manysimplewatch.go\n...\nADDED || kube-system\u002Fkube-proxy\nADDED || kube-system\u002Fkube-root-ca.crt\nADDED || kube-system\u002Fkubeadm-config\nADDED || kube-system\u002Fkubelet-config\nADDED || local-path-storage\u002Fkube-root-ca.crt\nADDED || local-path-storage\u002Flocal-path-config\nADDED || kube-system\u002Fkube-root-ca.crt\nADDED || kube-system\u002Fkubeadm-config\nADDED || kube-system\u002Fkubelet-config\nADDED || local-path-storage\u002Fkube-root-ca.crt\nADDED || local-path-storage\u002Flocal-path-config\n...\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cpre\u003E\u003Ccode\u003E$ kubectl create configmap testing\nconfigmap\u002Ftesting created\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cpre\u003E\u003Ccode\u003E...\nADDED || default\u002Ftesting\nADDED || default\u002Ftesting\nADDED || default\u002Ftesting\nADDED || default\u002Ftesting\nADDED || default\u002Ftesting\nADDED || default\u002Ftesting\nADDED || default\u002Ftesting\nADDED || default\u002Ftesting\nADDED || default\u002Ftesting\nADDED || default\u002Ftesting\n...\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EОглядываясь назад на наши показатели \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E, мы видим значительный скачок производительности процессора при запуске программы. Это вызывает беспокойство, но, возможно, еще более неприятным является объем работы, который был проделан при создании новой \u003Ccode\u003EConfigMap\u003C\u002Fcode\u003E. Пока нагрузка моделируется в программе, сервер Kubernetes API обслуживает запросы на просмотр от различных клиентов. Устанавливать наблюдение в \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E для каждого из них нет необходимости, ведь серверу API требуется только одно уведомление, чтобы проинформировать всех клиентов.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc9c\u002Fee7\u002F777\u002Fc9cee777704cc14b9c2e085f1788b3d0.png\" width=\"3830\" height=\"2016\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc9c\u002Fee7\u002F777\u002Fc9cee777704cc14b9c2e085f1788b3d0.png\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EДиапазон значений по оси Y составляет от \u003Ccode\u003E0,00\u003C\u002Fcode\u003E до \u003Ccode\u003E3,00\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cp\u003EПервый большой всплеск соответствует моменту запуска нашей программы. Второй всплеск, хотя и меньший, соответствует созданию единой \u003Ccode\u003EConfigMap\u003C\u002Fcode\u003E с установленными 10 000 наблюдениями.\u003C\u002Fp\u003E\u003Ch2\u003EКэширование\u003C\u002Fh2\u003E\u003Cp\u003EКак вы догадались, сервер API Kubernetes использует стратегию кэширования для решения этой проблемы, и взаимодействие со слоем кэширования во многом похоже на прямой вызов \u003Ccode\u003Eetcd3 storage.Interface\u003C\u002Fcode\u003E. Фактически, уровень кэширования реализует \u003Ccode\u003Estorage.Interface\u003C\u002Fcode\u003E тоже.\u003C\u002Fp\u003E\u003Cp\u003EПри построении \u003Ccode\u003Ecacher.Cacher\u003C\u002Fcode\u003E передается структура \u003Ccode\u003EConfig\u003C\u002Fcode\u003E, которая включает в себя \u003Ccode\u003Estorage.Interface\u003C\u002Fcode\u003E. Как указано в \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fkubernetes\u002Fkubernetes\u002Fblob\u002Fe818649c10f29bc80b874889a448da4023918330\u002Fstaging\u002Fsrc\u002Fk8s.io\u002Fapiserver\u002Fpkg\u002Fstorage\u002Fcacher\u002Fcacher.go#L241\"\u003E\u003Cu\u003Eстроке документа\u003C\u002Fu\u003E\u003C\u002Fa\u003E. \u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E\u002F\u002F Cacher implements storage.Interface (although most of the calls are just\n\u002F\u002F delegated to the underlying storage).\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EНапример, поскольку \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E информирует наблюдателя о событиях создания (\u003Ccode\u003EADDED\u003C\u002Fcode\u003E), \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fkubernetes\u002Fkubernetes\u002Fblob\u002Fe818649c10f29bc80b874889a448da4023918330\u002Fstaging\u002Fsrc\u002Fk8s.io\u002Fapiserver\u002Fpkg\u002Fstorage\u002Fcacher\u002Fcacher.go#L460\"\u003E\u003Cu\u003Eреализация\u003C\u002Fu\u003E \u003C\u002Fa\u003E\u003Ccode\u003ECreate() Cacher\u003C\u002Fcode\u003E напрямую вызывает \u003Ccode\u003Estorage Create()\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E\u002F\u002F Create implements storage.Interface.\nfunc (c *Cacher) Create(ctx context.Context, key string, obj, out runtime.Object, ttl uint64) error {\n\treturn c.storage.Create(ctx, key, obj, out, ttl)\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EДругие методы выполняют незначительные операции перед вызовом базового \u003Ccode\u003Estorage\u003C\u002Fcode\u003E, но \u003Ccode\u003EWatch()\u003C\u002Fcode\u003E вообще не взаимодействует с ним напрямую. Вместо этого он создает новый \u003Ccode\u003EcacheWatcher\u003C\u002Fcode\u003E и запускает свой цикл обработки событий. Прежде чем разобраться в том, как работает \u003Ccode\u003EcacheWatcher\u003C\u002Fcode\u003E, нужно понять, как события доставляются из \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E всем наблюдателям, запущенным этим методом. При создании Cacher создаются три важных базовых компонента, два из которых — реализация общих интерфейсов в пакете \u003Ccode\u003Eclient-go cache\u003C\u002Fcode\u003E:\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EwatchCache\u003C\u002Fcode\u003E — реализацией \u003Ccode\u003Ecache.Store\u003C\u002Fcode\u003E;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EcacherListerWatcher\u003C\u002Fcode\u003E — реализацией \u003Ccode\u003Ecache.ListerWatcher\u003C\u002Fcode\u003E;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EReflector\u003C\u002Fcode\u003E принимает реализации двух ранее упомянутых интерфейсов и использует последний для заполнения первого.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp\u003EДавайте рассмотрим каждый из них более подробно.\u003C\u002Fp\u003E\u003Ch2\u003EwatchCache\u003C\u002Fh2\u003E\u003Cp\u003E\u003Ccode\u003EwatchCache\u003C\u002Fcode\u003E  — место, где хранится фактический кэш событий, которые передаются наблюдателям. Это скользящее окно с возможностью изменения размера. Это  означает, что при добавлении нового элемента мы либо удаляем самый старый, либо увеличиваем размер кэша, чтобы вместить добавление нового элемента. Как упоминалось ранее, \u003Ccode\u003EwatchCache\u003C\u002Fcode\u003E реализует \u003Ccode\u003Ecache.Store\u003C\u002Fcode\u003E, которое поддерживает следующие методы.  \u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Etype Store interface {\n\n\t\u002F\u002F Add adds the given object to the accumulator associated with the given object's key\n\tAdd(obj interface{}) error\n\n\t\u002F\u002F Update updates the given object in the accumulator associated with the given object's key\n\tUpdate(obj interface{}) error\n\n\t\u002F\u002F Delete deletes the given object from the accumulator associated with the given object's key\n\tDelete(obj interface{}) error\n\n\t\u002F\u002F List returns a list of all the currently non-empty accumulators\n\tList() []interface{}\n\n\t\u002F\u002F ListKeys returns a list of all the keys currently associated with non-empty accumulators\n\tListKeys() []string\n\n\t\u002F\u002F Get returns the accumulator associated with the given object's key\n\tGet(obj interface{}) (item interface{}, exists bool, err error)\n\n\t\u002F\u002F GetByKey returns the accumulator associated with the given key\n\tGetByKey(key string) (item interface{}, exists bool, err error)\n\n\t\u002F\u002F Replace will delete the contents of the store, using instead the\n\t\u002F\u002F given list. Store takes ownership of the list, you should not reference\n\t\u002F\u002F it after calling this function.\n\tReplace([]interface{}, string) error\n\n\t\u002F\u002F Resync is meaningless in the terms appearing here but has\n\t\u002F\u002F meaning in some implementations that have non-trivial\n\t\u002F\u002F additional behavior (e.g., DeltaFIFO).\n\tResync() error\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EРеализации \u003Ccode\u003EAdd()\u003C\u002Fcode\u003E, \u003Ccode\u003EUpdate()\u003C\u002Fcode\u003E, и \u003Ccode\u003EDelete()\u003C\u002Fcode\u003E создают \u003Ccode\u003Ewatch.Event\u003C\u002Fcode\u003E, затем передайте его методу \u003Ccode\u003EprocessEvent()\u003C\u002Fcode\u003E. Здесь событие преобразуется в \u003Ccode\u003EwatchCacheEvent\u003C\u002Fcode\u003E, который передается \u003Ccode\u003EupdateCache()\u003C\u002Fcode\u003E. Метод \u003Ccode\u003EupdateCache()\u003C\u002Fcode\u003E вместе с вызываемым им методом \u003Ccode\u003EresizeCacheLocked()\u003C\u002Fcode\u003E — это то, где реализована логика скользящего окна.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E\u002F\u002F Assumes that lock is already held for write.\nfunc (w *watchCache) updateCache(event *watchCacheEvent) {\n\tw.resizeCacheLocked(event.RecordTime)\n\tif w.isCacheFullLocked() {\n\t\t\u002F\u002F Cache is full - remove the oldest element.\n\t\tw.startIndex++\n\t}\n\tw.cache[w.endIndex%w.capacity] = event\n\tw.endIndex++\n}\n\n\u002F\u002F resizeCacheLocked resizes the cache if necessary:\n\u002F\u002F - increases capacity by 2x if cache is full and all cached events occurred within last eventFreshDuration.\n\u002F\u002F - decreases capacity by 2x when recent quarter of events occurred outside of eventFreshDuration(protect watchCache from flapping).\nfunc (w *watchCache) resizeCacheLocked(eventTime time.Time) {\n\tif w.isCacheFullLocked() &amp;&amp; eventTime.Sub(w.cache[w.startIndex%w.capacity].RecordTime) &lt; eventFreshDuration {\n\t\tcapacity := min(w.capacity*2, w.upperBoundCapacity)\n\t\tif capacity \u003E w.capacity {\n\t\t\tw.doCacheResizeLocked(capacity)\n\t\t}\n\t\treturn\n\t}\n\tif w.isCacheFullLocked() &amp;&amp; eventTime.Sub(w.cache[(w.endIndex-w.capacity\u002F4)%w.capacity].RecordTime) \u003E eventFreshDuration {\n\t\tcapacity := max(w.capacity\u002F2, w.lowerBoundCapacity)\n\t\tif capacity &lt; w.capacity {\n\t\t\tw.doCacheResizeLocked(capacity)\n\t\t}\n\t\treturn\n\t}\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПеред возвратом из \u003Ccode\u003EprocessEvent()\u003C\u002Fcode\u003E вызывается функция \u003Ccode\u003EeventHandler()\u003C\u002Fcode\u003E, если она была передана во время построения \u003Ccode\u003EwatchCache\u003C\u002Fcode\u003E. Мы вернемся к этому вскоре, когда рассмотрим, как наблюдатели уведомляются о событиях.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E\u002F\u002F Avoid calling event handler under lock.\n\t\u002F\u002F This is safe as long as there is at most one call to Add\u002FUpdate\u002FDelete and\n\t\u002F\u002F UpdateResourceVersion in flight at any point in time, which is true now,\n\t\u002F\u002F because reflector calls them synchronously from its main thread.\n\tif w.eventHandler != nil {\n\t\tw.eventHandler(wcEvent)\n\t}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EДругие методы, особенно те, которые включают получение и перечисление, полагаются на базовый \u003Ccode\u003Ecache.Indexer\u003C\u002Fcode\u003E. В итоге \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fkubernetes\u002Fkubernetes\u002Fblob\u002Fe818649c10f29bc80b874889a448da4023918330\u002Fstaging\u002Fsrc\u002Fk8s.io\u002Fclient-go\u002Ftools\u002Fcache\u002Fstore.go#L271\"\u003E\u003Cu\u003Eпростые индексы\u003C\u002Fu\u003E\u003C\u002Fa\u003E, созданные в \u003Ccode\u003EwatchCache\u003C\u002Fcode\u003E, сводятся к потокобезопасной \u003Ccode\u003Emap\u003C\u002Fcode\u003E. В то время как скользящее окно событий в \u003Ccode\u003EwatchCache\u003C\u002Fcode\u003E помогает отправлять обновления многим различным наблюдателям, индексатор позволяет новым наблюдателям легко получать последнее состояние объектов, что требуется при запуске наблюдения.\u003C\u002Fp\u003E\u003Cp\u003EВместе эти два механизма обслуживают запросы из их хранилища в памяти, вместо того чтобы обращаться к \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E напрямую.\u003C\u002Fp\u003E\u003Ch2\u003EcacherListerWatcher\u003C\u002Fh2\u003E\u003Cp\u003E\u003Ccode\u003EcacherListerWatcher\u003C\u002Fcode\u003E намного проще, чем \u003Ccode\u003EwatchCache\u003C\u002Fcode\u003E, так как оборачивает \u003Ccode\u003Estorage.Interface\u003C\u002Fcode\u003E, который передается \u003Ccode\u003ECacher\u003C\u002Fcode\u003E и вызывает базовые методы \u003Ccode\u003EGetList()\u003C\u002Fcode\u003E и \u003Ccode\u003EWatch()\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E\u002F\u002F NewCacherListerWatcher returns a storage.Interface backed ListerWatcher.\nfunc NewCacherListerWatcher(storage storage.Interface, resourcePrefix string, newListFunc func() runtime.Object) cache.ListerWatcher {\n\treturn &amp;cacherListerWatcher{\n\t\tstorage:        storage,\n\t\tresourcePrefix: resourcePrefix,\n\t\tnewListFunc:    newListFunc,\n\t}\n}\n\n\u002F\u002F Implements cache.ListerWatcher interface.\nfunc (lw *cacherListerWatcher) List(options metav1.ListOptions) (runtime.Object, error) {\n\tlist := lw.newListFunc()\n\tpred := storage.SelectionPredicate{\n\t\tLabel:    labels.Everything(),\n\t\tField:    fields.Everything(),\n\t\tLimit:    options.Limit,\n\t\tContinue: options.Continue,\n\t}\n\n\tstorageOpts := storage.ListOptions{\n\t\tResourceVersionMatch: options.ResourceVersionMatch,\n\t\tPredicate:            pred,\n\t\tRecursive:            true,\n\t}\n\tif err := lw.storage.GetList(context.TODO(), lw.resourcePrefix, storageOpts, list); err != nil {\n\t\treturn nil, err\n\t}\n\treturn list, nil\n}\n\n\u002F\u002F Implements cache.ListerWatcher interface.\nfunc (lw *cacherListerWatcher) Watch(options metav1.ListOptions) (watch.Interface, error) {\n\topts := storage.ListOptions{\n\t\tResourceVersion: options.ResourceVersion,\n\t\tPredicate:       storage.Everything,\n\t\tRecursive:       true,\n\t\tProgressNotify:  true,\n\t}\n\treturn lw.storage.Watch(context.TODO(), lw.resourcePrefix, opts)\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003E\u003Ccode\u003EcacherListerWatcher\u003C\u002Fcode\u003E — то, что извлекает данные, которые сохраняются в \u003Ccode\u003EwatchCache\u003C\u002Fcode\u003E. Но нужен механизм, чтобы связать их вместе.\u003C\u002Fp\u003E\u003Ch2\u003EReflector\u003C\u002Fh2\u003E\u003Cp\u003E\u003Ccode\u003EwatchCache\u003C\u002Fcode\u003E и \u003Ccode\u003EcacherListerWatcher\u003C\u002Fcode\u003E создают перед \u003Ccode\u003EReflector\u003C\u002Fcode\u003E, чтобы передать их ему. \u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003EwatchCache := newWatchCache(\n\t\tconfig.KeyFunc, cacher.processEvent, config.GetAttrsFunc, config.Versioner, config.Indexers, config.Clock, config.GroupResource)\n\tlisterWatcher := NewCacherListerWatcher(config.Storage, config.ResourcePrefix, config.NewListFunc)\n\treflectorName := \"storage\u002Fcacher.go:\" + config.ResourcePrefix\n\n\treflector := cache.NewNamedReflector(reflectorName, listerWatcher, obj, watchCache, 0)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003E\u003Ccode\u003EReflector\u003C\u002Fcode\u003E определен в пакете \u003Ccode\u003Eclient-go\u002Ftools\u002Fcache\u003C\u002Fcode\u003E со следующей документальной строкой.  \u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E\u002F\u002F Reflector watches a specified resource and causes all changes to be reflected in the given store.\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EБольшая часть функциональности вызывается из его метода \u003Ccode\u003EListAndWatch()\u003C\u002Fcode\u003E Он выполняет то, что следует из его названия: перечисляет, а затем просматривает. События, поступающие от \u003Ccode\u003EListerWatcher (cacherListerWatcher)\u003C\u002Fcode\u003E, обрабатываются в \u003Ccode\u003EwatchHandler()\u003C\u002Fcode\u003E. Именно здесь данные передаются в \u003Ccode\u003EwatchCache\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E\t\tcase watch.Added:\n\t\t\t\terr := store.Add(event.Object)\n\t\t\t\tif err != nil {\n\t\t\t\t\tutilruntime.HandleError(fmt.Errorf(\"%s: unable to add watch event object (%#v) to store: %v\", name, event.Object, err))\n\t\t\t\t}\n\t\t\tcase watch.Modified:\n\t\t\t\terr := store.Update(event.Object)\n\t\t\t\tif err != nil {\n\t\t\t\t\tutilruntime.HandleError(fmt.Errorf(\"%s: unable to update watch event object (%#v) to store: %v\", name, event.Object, err))\n\t\t\t\t}\n\t\t\tcase watch.Deleted:\n\t\t\t\t\u002F\u002F TODO: Will any consumers need access to the \"last known\n\t\t\t\t\u002F\u002F state\", which is passed in event.Object? If so, may need\n\t\t\t\t\u002F\u002F to change this.\n\t\t\t\terr := store.Delete(event.Object)\n\t\t\t\tif err != nil {\n\t\t\t\t\tutilruntime.HandleError(fmt.Errorf(\"%s: unable to delete watch event object (%#v) from store: %v\", name, event.Object, err))\n\t\t\t\t}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Ch2\u003EСвязываем всё вместе\u003C\u002Fh2\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F966\u002F2c4\u002F00b\u002F9662c400bda4e392faa5d2aaf796fac5.png\" width=\"1920\" height=\"1080\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F966\u002F2c4\u002F00b\u002F9662c400bda4e392faa5d2aaf796fac5.png\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКогда все компоненты на месте, пора запустить \u003Ccode\u003EReflector\u003C\u002Fcode\u003E, чтобы извлекать данные из \u003Ccode\u003EcacherListerWatcher\u003C\u002Fcode\u003E и сохранять их в \u003Ccode\u003EwatchCache\u003C\u002Fcode\u003E, который будет информировать \u003Ccode\u003ECacher\u003C\u002Fcode\u003E об обновлениях.  \u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Ego cacher.dispatchEvents()\n\n\tcacher.stopWg.Add(1)\n\tgo func() {\n\t\tdefer cacher.stopWg.Done()\n\t\tdefer cacher.terminateAllWatchers()\n\t\twait.Until(\n\t\t\tfunc() {\n\t\t\t\tif !cacher.isStopped() {\n\t\t\t\t\tcacher.startCaching(stopCh)\n\t\t\t\t}\n\t\t\t}, time.Second, stopCh,\n\t\t)\n\t}()\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EСначала рассмотрим второй вызов, \u003Ccode\u003Ecacher.startCaching(stopCh)\u003C\u002Fcode\u003E — так мы запускаем \u003Ccode\u003EReflector\u003C\u002Fcode\u003E с помощью вызова \u003Ccode\u003EListAndWatch()\u003C\u002Fcode\u003E.  \u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Efunc (c *Cacher) startCaching(stopChannel &lt;-chan struct{}) {\n\t\u002F\u002F The 'usable' lock is always 'RLock'able when it is safe to use the cache.\n\t\u002F\u002F It is safe to use the cache after a successful list until a disconnection.\n\t\u002F\u002F We start with usable (write) locked. The below OnReplace function will\n\t\u002F\u002F unlock it after a successful list. The below defer will then re-lock\n\t\u002F\u002F it when this function exits (always due to disconnection), only if\n\t\u002F\u002F we actually got a successful list. This cycle will repeat as needed.\n\tsuccessfulList := false\n\tc.watchCache.SetOnReplace(func() {\n\t\tsuccessfulList = true\n\t\tc.ready.set(true)\n\t\tklog.V(1).Infof(\"cacher (%v): initialized\", c.groupResource.String())\n\t\tmetrics.WatchCacheInitializations.WithLabelValues(c.groupResource.String()).Inc()\n\t})\n\tdefer func() {\n\t\tif successfulList {\n\t\t\tc.ready.set(false)\n\t\t}\n\t}()\n\n\tc.terminateAllWatchers()\n\t\u002F\u002F Note that since onReplace may be not called due to errors, we explicitly\n\t\u002F\u002F need to retry it on errors under lock.\n\t\u002F\u002F Also note that startCaching is called in a loop, so there's no need\n\t\u002F\u002F to have another loop here.\n\tif err := c.reflector.ListAndWatch(stopChannel); err != nil {\n\t\tklog.Errorf(\"cacher (%v): unexpected ListAndWatch error: %v; reinitializing...\", c.groupResource.String(), err)\n\t}\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EЭто приведет к тому, что \u003Ccode\u003EReflector\u003C\u002Fcode\u003E начнет заполнять \u003Ccode\u003EwatchCache\u003C\u002Fcode\u003E, который уведомит \u003Ccode\u003ECacher\u003C\u002Fcode\u003E, чтобы он мог отправить его всем наблюдателям. Метод \u003Ccode\u003Ecacher.processEvent()\u003C\u002Fcode\u003E был передан в \u003Ccode\u003EwatchCache\u003C\u002Fcode\u003E как \u003Ccode\u003EeventHandler()\u003C\u002Fcode\u003E, который мы видели ранее.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Efunc (c *Cacher) processEvent(event *watchCacheEvent) {\n\tif curLen := int64(len(c.incoming)); c.incomingHWM.Update(curLen) {\n\t\t\u002F\u002F Monitor if this gets backed up, and how much.\n\t\tklog.V(1).Infof(\"cacher (%v): %v objects queued in incoming channel.\", c.groupResource.String(), curLen)\n\t}\n\tc.incoming &lt;- *event\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EВсё отправляется по каналу \u003Ccode\u003Ec.incoming\u003C\u002Fcode\u003E, который затем считывается в методе \u003Ccode\u003Ecacher.dispatchEvents()\u003C\u002Fcode\u003E, прежде чем быть отправленным каждому наблюдателю.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E\tcase event, ok := &lt;-c.incoming:\n\t\t\tif !ok {\n\t\t\t\treturn\n\t\t\t}\n\t\t\t\u002F\u002F Don't dispatch bookmarks coming from the storage layer.\n\t\t\t\u002F\u002F They can be very frequent (even to the level of subseconds)\n\t\t\t\u002F\u002F to allow efficient watch resumption on kube-apiserver restarts,\n\t\t\t\u002F\u002F and propagating them down may overload the whole system.\n\t\t\t\u002F\u002F\n\t\t\t\u002F\u002F TODO: If at some point we decide the performance and scalability\n\t\t\t\u002F\u002F footprint is acceptable, this is the place to hook them in.\n\t\t\t\u002F\u002F However, we then need to check if this was called as a result\n\t\t\t\u002F\u002F of a bookmark event or regular Add\u002FUpdate\u002FDelete operation by\n\t\t\t\u002F\u002F checking if resourceVersion here has changed.\n\t\t\tif event.Type != watch.Bookmark {\n\t\t\t\tc.dispatchEvent(&amp;event)\n\t\t\t}\n\t\t\tlastProcessedResourceVersion = event.ResourceVersion\n\t\t\tmetrics.EventsCounter.WithLabelValues(c.groupResource.String()).Inc()\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EКогда мы вызываем \u003Ccode\u003Ec.dispatchEvent(&amp;event)\u003C\u002Fcode\u003E, список \u003Ccode\u003EcacheWatcher\u003C\u002Fcode\u003E фильтруется по тем, кто заинтересован в данном событии, и событие отправляется каждому.  \u003C\u002Fp\u003E\u003Ch2\u003EМетод Watch()\u003C\u002Fh2\u003E\u003Cp\u003EЭто было непросто, но теперь, когда мы знаем, как обрабатываются события, пришло время вернуться к методу \u003Ccode\u003EWatch()\u003C\u002Fcode\u003E. Вместо запуска нового наблюдения \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E при вызове этого метода, создаем \u003Ccode\u003EcacheWatcher\u003C\u002Fcode\u003E, который добавляется к кандидатам, когда \u003Ccode\u003ECacher\u003C\u002Fcode\u003E обрабатывает события. Каждый \u003Ccode\u003EcacheWatcher\u003C\u002Fcode\u003E имеет свой собственный цикл обработки: \u003Ccode\u003Ewatcher.processInterval()\u003C\u002Fcode\u003E. Метод\u003Ccode\u003E Watch()\u003C\u002Fcode\u003E запускает цикл обработки для наблюдателя, который он создает после добавления его в список наблюдателей для \u003Ccode\u003ECacher\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Efunc() {\n\t\tc.Lock()\n\t\tdefer c.Unlock()\n\t\t\u002F\u002F Update watcher.forget function once we can compute it.\n\t\twatcher.forget = forgetWatcher(c, watcher, c.watcherIdx, triggerValue, triggerSupported)\n\t\tc.watchers.addWatcher(watcher, c.watcherIdx, triggerValue, triggerSupported)\n\n\t\t\u002F\u002F Add it to the queue only when the client support watch bookmarks.\n\t\tif watcher.allowWatchBookmarks {\n\t\t\tc.bookmarkWatchers.addWatcher(watcher)\n\t\t}\n\t\tc.watcherIdx++\n\t}()\n\n\tgo watcher.processInterval(ctx, cacheInterval, watchRV)\n\treturn watcher, nil\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003E\u003Ccode\u003EcacheInterval\u003C\u002Fcode\u003E создается \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fkubernetes\u002Fkubernetes\u002Fblob\u002Fe818649c10f29bc80b874889a448da4023918330\u002Fstaging\u002Fsrc\u002Fk8s.io\u002Fapiserver\u002Fpkg\u002Fstorage\u002Fcacher\u002Fcacher.go#L539\"\u003E\u003Cu\u003Eранее в методе\u003C\u002Fu\u003E \u003C\u002Fa\u003Eи доставляет любые существующие события в \u003Ccode\u003EwatchCache\u003C\u002Fcode\u003E, которые интересуют \u003Ccode\u003EcacheWatcher\u003C\u002Fcode\u003E. Метод \u003Ccode\u003Ewatcher.processInterval()\u003C\u002Fcode\u003E сначала обрабатывает все события из \u003Ccode\u003EcacheInterval\u003C\u002Fcode\u003E, затем начинает ожидать обработки будущих \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fkubernetes\u002Fkubernetes\u002Fblob\u002Fe818649c10f29bc80b874889a448da4023918330\u002Fstaging\u002Fsrc\u002Fk8s.io\u002Fapiserver\u002Fpkg\u002Fstorage\u002Fcacher\u002Fcacher.go#L1504\"\u003E\u003Cu\u003Eотправленных событий\u003C\u002Fu\u003E\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E\tfor {\n\t\tevent, err := cacheInterval.Next()\n\t\tif err != nil {\n\t\t\tklog.Warningf(\"couldn't retrieve watch event to serve: %#v\", err)\n\t\t\treturn\n\t\t}\n\t\tif event == nil {\n\t\t\tbreak\n\t\t}\n\t\tc.sendWatchCacheEvent(event)\n\t\t\u002F\u002F With some events already sent, update resourceVersion so that\n\t\t\u002F\u002F events that were buffered and not yet processed won't be delivered\n\t\t\u002F\u002F to this watcher second time causing going back in time.\n\t\tresourceVersion = event.ResourceVersion\n\t\tinitEventCount++\n\t}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003E\u003Cstrong\u003EПримечание\u003C\u002Fstrong\u003E: некоторые комментарии к коду удалены для краткости.\u003C\u002Fp\u003E\u003Cp\u003EОбработка событий состоит из вызова функции \u003Ccode\u003EsendWatchCacheEvent()\u003C\u002Fcode\u003E, которая преобразует его. Затем доставляет по каналу result, который становится тем же каналом, из которого вызывающие функцию \u003Ccode\u003EWatch()\u003C\u002Fcode\u003E могут считывать данные!\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Efunc (c *cacheWatcher) sendWatchCacheEvent(event *watchCacheEvent) {\n\twatchEvent := c.convertToWatchEvent(event)\n\tif watchEvent == nil {\n\t\t\u002F\u002F Watcher is not interested in that object.\n\t\treturn\n\t}\n\n\tselect {\n\tcase &lt;-c.done:\n\t\treturn\n\tdefault:\n\t}\n\n\tselect {\n\tcase c.result &lt;- *watchEvent:\n\tcase &lt;-c.done:\n\t}\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003E\u003Cstrong\u003EПримечание\u003C\u002Fstrong\u003E: некоторые комментарии к коду удалены для краткости.\u003C\u002Fp\u003E\u003Ch2\u003EВсе смотрят… Продуктивно  \u003C\u002Fh2\u003E\u003Cp\u003EДавайте посмотрим на реализацию \u003Ccode\u003ECacher storage.Interface\u003C\u002Fcode\u003E в действии. Мы берём нашу программу и модифицируем её, чтобы передать реализацию хранилища \u003Ccode\u003Eetcd Cacher\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Ecachewatch.go\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Epackage main\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"os\"\n\t\"os\u002Fsignal\"\n\n\t\"go.etcd.io\u002Fetcd\u002Fclient\u002Fpkg\u002Fv3\u002Ftransport\"\n\tclientv3 \"go.etcd.io\u002Fetcd\u002Fclient\u002Fv3\"\n\tv1 \"k8s.io\u002Fapi\u002Fcore\u002Fv1\"\n\t\"k8s.io\u002Fapimachinery\u002Fpkg\u002Ffields\"\n\t\"k8s.io\u002Fapimachinery\u002Fpkg\u002Flabels\"\n\t\"k8s.io\u002Fapimachinery\u002Fpkg\u002Fruntime\"\n\t\"k8s.io\u002Fapimachinery\u002Fpkg\u002Fruntime\u002Fserializer\"\n\t\"k8s.io\u002Fapiserver\u002Fpkg\u002Fstorage\"\n\t\"k8s.io\u002Fapiserver\u002Fpkg\u002Fstorage\u002Fcacher\"\n\t\"k8s.io\u002Fapiserver\u002Fpkg\u002Fstorage\u002Fetcd3\"\n\t\"k8s.io\u002Fapiserver\u002Fpkg\u002Fstorage\u002Fvalue\u002Fencrypt\u002Fidentity\"\n\t\"k8s.io\u002Fkubernetes\u002Fpkg\u002Fapis\u002Fcore\"\n\tk8sv1 \"k8s.io\u002Fkubernetes\u002Fpkg\u002Fapis\u002Fcore\u002Fv1\"\n\t\"k8s.io\u002Futils\u002Fclock\"\n)\n\nfunc main() {\n\ttlsConfig, err := (transport.TLSInfo{\n\t\tCertFile:       \".\u002Fpki\u002Fetcd\u002Fserver.crt\",\n\t\tKeyFile:        \".\u002Fpki\u002Fetcd\u002Fserver.key\",\n\t\tTrustedCAFile:  \".\u002Fpki\u002Fetcd\u002Fca.crt\",\n\t\tClientCertFile: \".\u002Fpki\u002Fapiserver-etcd-client.crt\",\n\t\tClientKeyFile:  \".\u002Fpki\u002Fapiserver-etcd-client.key\",\n\t}).ClientConfig()\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tc, err := clientv3.New(clientv3.Config{\n\t\tEndpoints: []string{\"https:\u002F\u002F127.0.0.1:2379\"},\n\t\tTLS:       tlsConfig,\n\t})\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\n\tscheme := runtime.NewScheme()\n\tk8sv1.AddToScheme(scheme)\n\tcore.AddToScheme(scheme)\n\tf := serializer.NewCodecFactory(scheme)\n\ts := etcd3.New(c, f.CodecForVersions(nil, f.UniversalDecoder(), nil, k8sv1.SchemeGroupVersion), nil, \"registry\", v1.Resource(\"ConfigMap\"), identity.NewEncryptCheckTransformer(), true, etcd3.NewDefaultLeaseManagerConfig())\n\n\tca, err := cacher.NewCacherFromConfig(cacher.Config{\n\t\tStorage:        s,\n\t\tVersioner:      storage.APIObjectVersioner{},\n\t\tGroupResource:  v1.Resource(\"configmaps\"),\n\t\tResourcePrefix: \"configmaps\",\n\t\tKeyFunc:        func(o runtime.Object) (string, error) { return storage.NamespaceKeyFunc(\"configmaps\", o) },\n\t\tGetAttrsFunc: func(o runtime.Object) (label labels.Set, field fields.Set, err error) {\n\t\t\treturn labels.Set{},\n\t\t\t\tfields.Set{}, nil\n\t\t},\n\t\tNewFunc: func() runtime.Object {\n\t\t\treturn &amp;v1.ConfigMap{}\n\t\t},\n\t\tNewListFunc: func() runtime.Object {\n\t\t\treturn &amp;v1.ConfigMapList{}\n\t\t},\n\t\tCodec: f.LegacyCodec(k8sv1.SchemeGroupVersion),\n\t\tClock: clock.RealClock{},\n\t})\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfor i := 0; i &lt; 10000; i++ {\n\t\tw, err := ca.Watch(context.Background(), \"configmaps\", storage.ListOptions{\n\t\t\tPredicate: storage.Everything,\n\t\t\tRecursive: true,\n\t\t})\n\t\tif err != nil {\n\t\t\tpanic(err)\n\t\t}\n\t\tgo func() {\n\t\t\tfor e := range w.ResultChan() {\n\t\t\t\tswitch o := e.Object.(type) {\n\t\t\t\tcase *v1.ConfigMap:\n\t\t\t\t\tfmt.Printf(\"%s || %s\u002F%s\\n\", e.Type, o.Namespace, o.Name)\n\t\t\t\tdefault:\n\t\t\t\t\tco, ok := o.(runtime.CacheableObject)\n\t\t\t\t\tif !ok {\n\t\t\t\t\t\tpanic(\"unknown event\")\n\t\t\t\t\t}\n\t\t\t\t\tc, ok := co.GetObject().(*v1.ConfigMap)\n\t\t\t\t\tif !ok {\n\t\t\t\t\t\tpanic(\"unknown object\")\n\t\t\t\t\t}\n\t\t\t\t\tfmt.Printf(\"%s || %s\u002F%s\\n\", e.Type, c.Namespace, c.Name)\n\t\t\t\t}\n\t\t\t}\n\t\t}()\n\t}\n\n\tstop := make(chan os.Signal)\n\tsignal.Notify(stop, os.Interrupt)\n\t&lt;-stop\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПоскольку \u003Ccode\u003EPrometheus\u003C\u002Fcode\u003E все еще запущен и очищает наш экземпляр \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E в нашем кластере \u003Ccode\u003Ekind\u003C\u002Fcode\u003E, мы запускаем нашу программу и видим влияние на процессор.  \u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E$ go run cachewatch.go\n...\nADDED || kube-system\u002Fkube-proxy\nADDED || kube-public\u002Fcluster-info\nADDED || kube-system\u002Fcoredns\nADDED || default\u002Fkube-root-ca.crt\nADDED || kube-public\u002Fkube-root-ca.crt\nADDED || kube-system\u002Fkubelet-config\nADDED || kube-system\u002Fkubeadm-config\nADDED || kube-system\u002Fkubeadm-config\nADDED || local-path-storage\u002Fkube-root-ca.crt\nADDED || local-path-storage\u002Flocal-path-config\nADDED || default\u002Fkube-root-ca.crt\n...\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EХотя установлено 10 000 наблюдателей, в нашем экземпляре \u003Ccode\u003Eetcd\u003C\u002Fcode\u003E нет заметного влияния на процессор. То же самое справедливо, если мы создадим новую \u003Ccode\u003EConfigMap\u003C\u002Fcode\u003E.  \u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E$ kubectl create configmap testing\nconfigmap\u002Ftesting created\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cpre\u003E\u003Ccode\u003E...\nADDED || default\u002Ftesting2\nADDED || default\u002Ftesting2\nADDED || default\u002Ftesting2\nADDED || default\u002Ftesting2\nADDED || default\u002Ftesting2\nADDED || default\u002Ftesting2\nADDED || default\u002Ftesting2\nADDED || default\u002Ftesting2\nADDED || default\u002Ftesting2\n...\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F4b4\u002F55f\u002F711\u002F4b455f711901c4aae77963b01c4330b3.png\" width=\"3680\" height=\"1956\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F4b4\u002F55f\u002F711\u002F4b455f711901c4aae77963b01c4330b3.png\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EДиапазон оси\u003Cem\u003E \u003C\u002Fem\u003EY \u003Ccode\u003E0.00\u003C\u002Fcode\u003E\u003Cem\u003Eдо \u003C\u002Fem\u003E\u003Ccode\u003E0.18\u003C\u002Fcode\u003E\u003Cem\u003E.\u003C\u002Fem\u003E  \u003C\u002Fp\u003E\u003Ch2\u003EЗаключительные мысли\u003C\u002Fh2\u003E\u003Cp\u003EЭто была вторая часть серии приключений \u003Ca href=\"https:\u002F\u002Fdanielmangum.com\u002Fcategories\u002Fkubernetes-api-server-adventures\u002F\"\u003E\u003Cu\u003Eсервера Kubernetes API\u003C\u002Fu\u003E\u003C\u002Fa\u003E. Основываясь на нашем storage.Interface, мы узнали, как Kubernetes оптимизирует работу watch перед лицом потенциально большого количества клиентов. Как и в большинстве случаев в разработке программного обеспечения, эта оптимизация не лишена компромиссов, но она достигает цели сделать общий случай более эффективным. В \u003Ca href=\"https:\u002F\u002Fslurm.club\u002F3KhyGtd\"\u003E\u003Cu\u003E«Kubernetes: Мега»\u003C\u002Fu\u003E \u003C\u002Fa\u003Eмы рассматриваем и затрагиваем такие области управления инфраструктурой, в которых каждое улучшение может помочь компании сэкономить сотни тысяч рублей.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3a1\u002F637\u002F2e5\u002F3a16372e5f1d1eeb7e513e97e17ef83f.png\" alt=\"https:\u002F\u002Fslurm.club\u002F3KhyGtd\" title=\"https:\u002F\u002Fslurm.club\u002F3KhyGtd\" width=\"780\" height=\"100\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3a1\u002F637\u002F2e5\u002F3a16372e5f1d1eeb7e513e97e17ef83f.png\"\u002F\u003E\u003Cdiv\u003E\u003Cfigcaption\u003E\u003Ca href=\"https:\u002F\u002Fslurm.club\u002F3KhyGtd\"\u003Ehttps:\u002F\u002Fslurm.club\u002F3KhyGtd\u003C\u002Fa\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Fdiv\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EМы посмотрим, есть ли какие-либо случаи, когда этот компромисс вызывает проблемы, в будущих публикациях.\u003C\u002Fp\u003E\u003Cp\u003E\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"network"},{"titleHtml":"kubernetes"},{"titleHtml":"k8s"},{"titleHtml":"slurm"},{"titleHtml":"it-компании"},{"titleHtml":"it-инфраструктура"},{"titleHtml":"карьера программиста"},{"titleHtml":"карьера ит-специалиста"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F446\u002F913\u002Fa17\u002F446913a171b09a149098ae918196b04b.png","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F446\u002F913\u002Fa17\u002F446913a171b09a149098ae918196b04b.png","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fcompanies\\\u002Fsouthbridge\\\u002Farticles\\\u002F727510\\\u002F\"},\"headline\":\"Мир приключений по API-серверу Kubernetes. Часть 2. Наблюдение и кэширование\",\"datePublished\":\"2023-04-07T16:02:21+03:00\",\"dateModified\":\"2023-04-07T17:39:24+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Аня Сокол\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"В нашей предыдущей статье про приключения сервера Kubernetes API мы рассмотрели интерфейс хранилища и исследовали единственную реализацию в дереве: etcd3. Однако...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fcompanies\\\u002Fsouthbridge\\\u002Farticles\\\u002F727510\\\u002F#post-content-body\",\"about\":[\"c_southbridge\",\"h_it-infrastructure\",\"h_devops\",\"h_kubernetes\",\"f_develop\",\"f_admin\"],\"image\":[\"https:\\\u002F\\\u002Fhabr.com\\\u002Fshare\\\u002Fpublication\\\u002F727510\\\u002Fb908dcce2dca0bfeea9d535492bee058\\\u002F\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F446\\\u002F913\\\u002Fa17\\\u002F446913a171b09a149098ae918196b04b.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F934\\\u002F15e\\\u002F43f\\\u002F93415e43f565a17db6ed85ce047607db.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F3a1\\\u002Fe4c\\\u002Fb70\\\u002F3a1e4cb705e9372e9e24451daed74cf6.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fc9c\\\u002Fee7\\\u002F777\\\u002Fc9cee777704cc14b9c2e085f1788b3d0.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F966\\\u002F2c4\\\u002F00b\\\u002F9662c400bda4e392faa5d2aaf796fac5.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F4b4\\\u002F55f\\\u002F711\\\u002F4b455f711901c4aae77963b01c4330b3.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F3a1\\\u002F637\\\u002F2e5\\\u002F3a16372e5f1d1eeb7e513e97e17ef83f.png\"]}","metaDescription":"В нашей предыдущей статье про приключения сервера Kubernetes API мы рассмотрели интерфейс хранилища и исследовали единственную реализацию в дереве: etcd3. Однако внимательное прочтение сносок в этом...","mainImageUrl":null,"amp":true,"customTrackerLinks":[]},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"hasPinnedComments":false,"format":null,"banner":null,"multiwidget":null,"readingTime":19,"complexity":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{"userReasonsList":null}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":""},"comments":{"articleComments":{},"articlePinnedComments":{},"searchCommentsResults":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{"southbridge":{"alias":"southbridge","imageUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fcompany\u002F754\u002Fd93\u002F3ca\u002F754d933caeb494c6127add17ff60feb5.png","titleHtml":"Southbridge","descriptionHtml":"Обеспечиваем стабильную работу highload-проектов","relatedData":null,"statistics":{"subscribersCount":47103,"rating":241.54,"invest":null,"postsCount":769,"newsCount":249,"vacanciesCount":1,"employeesCount":23,"careerRating":4.29},"foundationDate":{"year":"2008","month":"02","day":"22"},"location":{"city":{"id":"447159","title":"Москва"},"region":{"id":"1885","title":"Москва и Московская обл."},"country":{"id":"168","title":"Россия"}},"siteUrl":"https:\u002F\u002Fsouthbridge.io","staffNumber":"51–100 человек","registrationDate":"2012-11-15T08:41:16+00:00","representativeUser":{"alias":"aSkobin","fullname":"Антон Скобин"},"contacts":[{"title":"Сайт","url":"https:\u002F\u002Fsouthbridge.io\u002F","siteTitle":"Southbridge.io — DevOps и Kubernetes | Поддержка серверов 24\u002F7","favicon":"https:\u002F\u002Fstatic.tildacdn.com\u002Ftild3238-6664-4439-b664-353437353037\u002Ffavicon.ico"},{"title":"Сайт","url":"https:\u002F\u002Fslurm.io\u002F","siteTitle":"Слёрм: учебный центр","favicon":"https:\u002F\u002Fstatic.tildacdn.com\u002Ftild3531-3930-4630-a534-316338333331\u002Ffavicon.ico"}],"settings":{"analyticsSettings":[{"type":"ga","trackingId":"UA-78870906-5"},{"type":"ym","trackingId":"49219348"}],"branding":null,"status":"active","isStartup":false,"hasActivePolls":false},"metadata":{"titleHtml":"Southbridge, Москва - Обеспечиваем стабильную работу highload-проектов с 22 февраля 2008 г.","title":"Southbridge, Москва - Обеспечиваем стабильную работу highload-проектов с 22 февраля 2008 г.","keywords":["IT-инфраструктура","DevOps","Системное администрирование","Карьера в IT-индустрии","Программирование","kubernetes","devops","слёрм","k8s","docker","обучение","ansible","sre","it-инфраструктура","ci\u002Fcd","linux","gitlab","вебинар","centos-admin.ru","kafka","apache kafka","postgresql","python","микросервисы","southbridge"],"descriptionHtml":"769 статей от авторов компании Southbridge","description":"769 статей от авторов компании Southbridge"},"aDeskSettings":null,"careerAlias":"southbridge"}},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"multiwidgets":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"multiwidgetLoading":false,"vacancies":{},"companiesGalleries":{},"companiesBanners":{},"companiesLandingVacancies":{},"companiesTechnologies":{},"workplaceInfo":null},"companyAdmin":{"companyInfo":null,"companyInfoLoading":false,"faqArticles":null,"brandingPreviewImageUrl":null,"jivoStatus":0,"adminNotifications":null},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":true},"flows":{"updates":{"countNewPostsBySubscription":null,"countNewPostsAll":54,"countNewNewsAll":49},"flows":[{"alias":"develop","id":"1","route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":"6","route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":"2","route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":"3","route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":"4","route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":"7","route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""}},"me":{"user":null,"uuid":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"modal":{"modals":[]},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"promoData":{"isLoading":false,"hasLoaded":false,"featurer":null,"megaposts":null,"promoLinks":null,"promoPosts":null},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"search":{"searchQueryError":null},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"stories":{"stories":[]},"technotext":{"years":[],"technotextDocForNominees":null,"technotextDocForWinners":null,"technotextInfo":{},"technotextInfoLoading":false,"technotextWinners":{},"technotextWinnersLoading":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"userVotes":{"karmaVotesList":[],"karmaVotesPagesCount":null,"karmaVotesListLoading":false,"commentsVotesList":[],"commentsVotesPagesCount":null,"commentsVotesListLoading":false,"postsVotesList":[],"postsVotesPagesCount":null,"postsVotesListLoading":false,"userVotesList":[],"userVotesPagesCount":null,"userVotesListLoading":false},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"userSpecialization":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script> 
  <script src="https://assets.habr.com/habr-web/js/chunk-vendors.04dfe291.js" defer></script>
  <script src="https://assets.habr.com/habr-web/js/7298.c8f1d73c.js" defer></script>
  <script src="https://assets.habr.com/habr-web/js/app.de623c19.js" defer></script> 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-726094-1"></script> 
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    </script> 
  <script type="text/javascript">
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script> 
  <noscript> 
   <div> 
    <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt=""> 
   </div> 
  </noscript> 
  <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script> 
  <script src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true"></script>  
 </body>
</html>